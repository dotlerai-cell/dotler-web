<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline' 'unsafe-eval' https://generativelanguage.googleapis.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https:;" />
  <title>Adnalytics</title>
  <style>
<!-- ADD THIS CSS TO YOUR EXISTING <style> SECTION -->

/* Top Navigation Buttons */
.top-nav-buttons {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 1002;
  display: flex;
  gap: 15px;
}

.nav-btn {
  background: white;
  border: 2px solid #dc2626;
  color: #dc2626;
  padding: 10px 24px;
  border-radius: 25px;
  cursor: pointer;
  font-weight: 600;
  font-size: 0.95em;
  transition: all 0.3s;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.nav-btn:hover {
  background: #dc2626;
  color: white;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
}

/* Contact Us Page */
.contact-page {
  min-height: 100vh;
  background: #f5f7fa;
  padding: 80px 20px 40px;
}

.contact-container {
  max-width: 1200px;
  margin: 0 auto;
}

.contact-header {
  text-align: center;
  margin-bottom: 50px;
}

.contact-header h1 {
  font-size: 3em;
  color: #333;
  margin-bottom: 15px;
  background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.contact-header p {
  font-size: 1.2em;
  color: #666;
  line-height: 1.6;
}

.contact-content {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 40px;
  margin-bottom: 40px;
}

.contact-form-section, .contact-info-section {
  background: white;
  border-radius: 16px;
  padding: 40px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
}

.contact-form-section h2, .contact-info-section h2 {
  color: #dc2626;
  margin-bottom: 25px;
  font-size: 1.8em;
}

.form-field {
  margin-bottom: 20px;
}

.form-field label {
  display: block;
  font-weight: 600;
  margin-bottom: 8px;
  color: #333;
}

.form-field input, .form-field textarea {
  width: 100%;
  padding: 12px;
  border: 2px solid #ddd;
  border-radius: 8px;
  font-size: 1em;
  transition: border-color 0.3s;
  font-family: inherit;
}

.form-field input:focus, .form-field textarea:focus {
  outline: none;
  border-color: #dc2626;
}

.form-field textarea {
  min-height: 120px;
  resize: vertical;
}

.submit-btn {
  background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
  color: white;
  border: none;
  padding: 14px 40px;
  font-size: 1.1em;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s;
  width: 100%;
}

.submit-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(220, 38, 38, 0.4);
}

.contact-detail {
  display: flex;
  align-items: flex-start;
  gap: 15px;
  margin-bottom: 25px;
  padding: 15px;
  background: #f8f9fa;
  border-radius: 8px;
}

.contact-icon {
  width: 40px;
  height: 40px;
  background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.contact-detail-content h3 {
  color: #333;
  margin-bottom: 5px;
  font-size: 1.1em;
}

.contact-detail-content p {
  color: #666;
  line-height: 1.6;
}

.contact-detail-content a {
  color: #dc2626;
  text-decoration: none;
}

.contact-detail-content a:hover {
  text-decoration: underline;
}

.social-links {
  display: flex;
  gap: 15px;
  margin-top: 20px;
}

.social-link {
  width: 45px;
  height: 45px;
  background: #dc2626;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  text-decoration: none;
  transition: all 0.3s;
}

.social-link:hover {
  background: #991b1b;
  transform: translateY(-3px);
}

/* About Us Page */
.about-page {
  min-height: 100vh;
  background: #f5f7fa;
  padding: 80px 20px 40px;
}

.about-container {
  max-width: 1200px;
  margin: 0 auto;
}

.about-hero {
  background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
  border-radius: 20px;
  padding: 60px 40px;
  text-align: center;
  color: white;
  margin-bottom: 50px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
}

.about-hero h1 {
  font-size: 3.5em;
  margin-bottom: 20px;
}

.about-hero p {
  font-size: 1.3em;
  line-height: 1.8;
  opacity: 0.95;
}

.about-section {
  background: white;
  border-radius: 16px;
  padding: 40px;
  margin-bottom: 30px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
}

.about-section h2 {
  color: #dc2626;
  font-size: 2em;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 15px;
}

.about-section p {
  color: #666;
  line-height: 1.8;
  font-size: 1.05em;
  margin-bottom: 15px;
}

.about-section ul {
  list-style: none;
  padding: 0;
}

.about-section li {
  padding: 12px 0;
  padding-left: 30px;
  position: relative;
  color: #666;
  line-height: 1.6;
}

.about-section li:before {
  content: "âœ“";
  position: absolute;
  left: 0;
  color: #dc2626;
  font-weight: bold;
  font-size: 1.2em;
}

.process-steps {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 25px;
  margin-top: 30px;
}

.process-step {
  background: #f8f9fa;
  padding: 25px;
  border-radius: 12px;
  border-left: 4px solid #dc2626;
}

.process-step h4 {
  color: #dc2626;
  margin-bottom: 10px;
  font-size: 1.2em;
}

.process-step p {
  color: #666;
  font-size: 0.95em;
  line-height: 1.6;
}

.back-btn {
  background: #dc2626;
  color: white;
  border: none;
  padding: 12px 30px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  font-size: 1em;
  transition: all 0.3s;
  margin-top: 20px;
}

.back-btn:hover {
  background: #991b1b;
  transform: translateY(-2px);
}

.back-arrow-btn {
  position: fixed;
  top: 20px;
  left: 20px;
  z-index: 1003;
  width: 50px;
  height: 50px;
  background: white;
  border: 2px solid #dc2626;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.back-arrow-btn:hover {
  background: #dc2626;
  transform: translateX(-3px);
  box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
}

.back-arrow-btn:hover svg {
  fill: white;
}

@media (max-width: 768px) {
  .contact-content {
    grid-template-columns: 1fr;
  }
  
  .top-nav-buttons {
    top: 10px;
    right: 10px;
  }
  
  .nav-btn {
    padding: 8px 16px;
    font-size: 0.85em;
  }
}
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #f5f7fa;
      min-height: 100vh;
      color: #333;
      position: relative;
      overflow-x: hidden;
    }

    /* Floating tech squares animation */
    .tech-squares {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
    }

    .tech-square {
      position: absolute;
      border: 2px solid rgba(255, 255, 255, 0.15);
      background: rgba(255, 255, 255, 0.05);
      animation: float 20s infinite ease-in-out;
    }

    @keyframes float {
      0%, 100% {
        transform: translate(0, 0) rotate(0deg);
      }
      25% {
        transform: translate(30px, -30px) rotate(90deg);
      }
      50% {
        transform: translate(-20px, -60px) rotate(180deg);
      }
      75% {
        transform: translate(-40px, -30px) rotate(270deg);
      }
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* Ensure content is above floating squares */
    #step1-landing,
    #step2-config,
    #step3-customer,
    #dashboard {
      position: relative;
      z-index: 1;
    }

    .hidden {
      display: none !important;
    }

    /* Step 1: Landing Page */
    #step1-landing {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .landing-card {
      background: white;
      border-radius: 16px;
      padding: 60px 40px;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      text-align: center;
    }

    .landing-card h1 {
      font-size: 2.5em;
      margin-bottom: 20px;
      background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .landing-card p {
      font-size: 1.1em;
      color: #666;
      margin-bottom: 40px;
      line-height: 1.6;
    }

    .google-btn {
      background: white;
      border: 2px solid #ddd;
      padding: 16px 32px;
      font-size: 1.1em;
      border-radius: 8px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 12px;
      transition: all 0.3s;
      font-weight: 500;
    }

    .google-btn:hover {
      background: #f8f9fa;
      border-color: #dc2626;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
    }

    .user-id-input {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 1em;
      margin-bottom: 20px;
      transition: border-color 0.3s;
    }

    .user-id-input:focus {
      outline: none;
      border-color: #dc2626;
    }

    /* Steps 2 & 3 */
    .step-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
    }

    .step-card {
      background: white;
      border-radius: 16px;
      padding: 40px;
      max-width: 700px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .step-card h2 {
      font-size: 2em;
      margin-bottom: 10px;
      color: #333;
    }

    .step-card .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 1.1em;
    }

    .form-group {
      margin-bottom: 25px;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #333;
    }

    .form-group input {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 1em;
      transition: border-color 0.3s;
    }

    .form-group input:focus {
      outline: none;
      border-color: #dc2626;
    }

    .form-group input:disabled {
      background: #f5f5f5;
      color: #999;
      cursor: not-allowed;
      opacity: 0.7;
    }

    .help-text {
      background: #fef2f2;
      border-left: 4px solid #dc2626;
      padding: 12px;
      margin-top: 8px;
      border-radius: 4px;
      font-size: 0.95em;
      color: #555;
      line-height: 1.5;
    }

    .help-text strong {
      color: #dc2626;
    }

    .primary-btn {
      background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
      color: white;
      border: none;
      padding: 14px 32px;
      font-size: 1.1em;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      width: 100%;
    }

    .primary-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(220, 38, 38, 0.4);
    }

    .primary-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .success-msg {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .error-msg {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    #dashboard {
      background: #f5f7fa;
      min-height: 100vh;
    }

    .tab-content {
      padding: 15px 40px 40px 40px;
    }

    .controls-bar {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 30px;
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .control-group {
      flex: 1;
      min-width: 250px;
    }

    .control-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #333;
      font-size: 0.9em;
    }

    .control-group select {
      width: 100%;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 1em;
      background: white;
      cursor: pointer;
      transition: border-color 0.3s;
    }

    .control-group select:focus {
      outline: none;
      border-color: #dc2626;
    }

    .info-strip {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .info-card {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .info-card-label {
      font-size: 0.8em;
      color: #666;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 10px;
    }

    .info-card-value {
      font-size: 1.2em;
      font-weight: 700;
      color: #333;
      word-wrap: break-word;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
    }

    .metric-card {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      transition: transform 0.3s, box-shadow 0.3s;
    }

    .metric-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    }

    .metric-label {
      font-size: 0.9em;
      color: #666;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .metric-value {
      font-size: 2em;
      font-weight: 700;
      color: #dc2626;
    }

    .metric-unit {
      font-size: 0.6em;
      color: #999;
      margin-left: 4px;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }

    .empty-state h3 {
      font-size: 1.5em;
      margin-bottom: 10px;
      color: #999;
    }

    .code-block {
      background: #2d3748;
      color: #f7fafc;
      padding: 20px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 0.95em;
      margin-bottom: 20px;
      overflow-x: auto;
    }

    .placeholder-section {
      background: white;
      padding: 40px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .placeholder-section h3 {
      color: #dc2626;
      margin-bottom: 10px;
    }

    .placeholder-section p {
      color: #666;
      line-height: 1.6;
    }

    @media (max-width: 768px) {
      .dashboard-header {
        padding: 20px;
      }

      .tab-content {
        padding: 20px;
      }

      .controls-bar {
        flex-direction: column;
      }

      .control-group {
        width: 100%;
      }
    }
    /* Modal styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 20px;
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      padding: 30px;
      max-width: 900px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      position: relative;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }

    .modal-title {
      font-size: 1.8em;
      color: #dc2626;
      margin: 0;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 2em;
      color: #999;
      cursor: pointer;
      padding: 0;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.3s;
    }

    .modal-close:hover {
      background: #f5f5f5;
      color: #333;
    }

    .chart-container {
      width: 100%;
      height: 400px;
      margin-top: 20px;
    }

    .loading-spinner {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
      color: #dc2626;
      font-size: 1.2em;
    }
    /* Sidebar Styles */
.sidebar {
  position: fixed;
  left: 0;
  top: 0;
  height: 100%;
  width: 260px;
  background: white;
  box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
  z-index: 1000;
  transition: transform 0.3s ease;
  overflow-y: auto;
  display: none; /* Hidden by default */
}

.sidebar.visible {
  display: block; /* Show when dashboard is active */
}

.sidebar.collapsed {
  transform: translateX(-260px);
}

.sidebar-header {
  display: none;
}

.sidebar-nav {
  padding: 80px 0 20px 0;
}

.sidebar-item {
  display: flex;
  align-items: center;
  padding: 14px 25px;
  color: #666;
  text-decoration: none;
  transition: all 0.3s;
  cursor: pointer;
  border-left: 3px solid transparent;
  font-weight: 500;
}

.sidebar-item:hover {
  background: #f8f9fa;
  color: #dc2626;
  border-left-color: #dc2626;
}

.sidebar-item.active {
  background: #fef2f2;
  color: #dc2626;
  border-left-color: #dc2626;
}

.sidebar-icon {
  width: 20px;
  margin-right: 12px;
  font-size: 1.1em;
}

.hamburger {
  display: none;
  position: fixed;
  top: 20px;
  left: 20px;
  z-index: 1001;
  background: white;
  border: none;
  padding: 12px;
  border-radius: 8px;
  cursor: pointer;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
  transition: all 0.3s;
}

.user-greeting {
  display: none;
  position: fixed;
  top: 25px;
  left: 80px;
  z-index: 1001;
  color: #dc2626;
  font-weight: 600;
  font-size: 1em;
  background: white;
  padding: 8px 16px;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.hamburger:hover {
  background: #f8f9fa;
}

.hamburger span {
  display: block;
  width: 25px;
  height: 3px;
  background: #dc2626;
  margin: 5px 0;
  transition: all 0.3s;
  border-radius: 2px;
}

/* Adjust dashboard for sidebar */
#dashboard {
  margin-left: 260px;
  transition: margin-left 0.3s ease;
}

#dashboard.sidebar-collapsed {
  margin-left: 0;
}

/* Mobile responsive */
@media (max-width: 768px) {
  .sidebar {
    transform: translateX(-260px);
  }
  
  .sidebar.open {
    transform: translateX(0);
  }
  
  .hamburger {
    display: block;
  }
  
  #dashboard {
    margin-left: 0;
  }
  
  .sidebar-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 999;
  }
  
  .sidebar-overlay.active {
    display: block;
  }
}

/* Header shadow divider */
.header-shadow-divider {
  width: 100%;
  height: 2px;
  background: linear-gradient(to bottom, rgba(0, 0, 0, 0.08), transparent);
  position: relative;
  z-index: 1;
}

/* Account page styles */
.account-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  gap: 30px;
  margin-bottom: 30px;
}

.account-section {
  background: white;
  border-radius: 12px;
  padding: 24px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.account-section h3 {
  color: #dc2626;
  margin-bottom: 20px;
  font-size: 1.3em;
  border-bottom: 2px solid #f0f0f0;
  padding-bottom: 10px;
}

.account-field {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 0;
  border-bottom: 1px solid #f5f5f5;
}

.account-field:last-child {
  border-bottom: none;
}

.account-field-label {
  font-weight: 600;
  color: #333;
  display: flex;
  align-items: center;
  gap: 8px;
}

.account-field-value {
  color: #666;
  font-family: monospace;
  background: #f8f9fa;
  padding: 6px 12px;
  border-radius: 6px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.account-field-value.readonly {
  background: #f0f0f0;
  color: #999;
}

.account-field-value.editable {
  background: white;
  border: 2px solid #ddd;
  cursor: pointer;
}

.account-field-value.editing {
  background: white;
  border: 2px solid #dc2626;
}

.account-btn {
  background: #dc2626;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.85em;
  transition: all 0.3s;
}

.account-btn:hover {
  background: #b91c1c;
}

.account-btn.secondary {
  background: #6c757d;
}

.account-btn.danger {
  background: #dc3545;
}

.account-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.account-actions {
  display: flex;
  gap: 10px;
  margin-top: 20px;
}

.account-toast {
  position: fixed;
  top: 20px;
  right: 20px;
  background: #28a745;
  color: white;
  padding: 12px 20px;
  border-radius: 8px;
  z-index: 10000;
  animation: slideIn 0.3s ease;
}

.account-toast.error {
  background: #dc3545;
}

@keyframes slideIn {
  from { transform: translateX(100%); }
  to { transform: translateX(0); }
}

.phone-edit-container {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-top: 12px;
}

.phone-input-row {
  display: flex;
  align-items: center;
  gap: 8px;
}

.country-selector {
  position: relative;
  width: 120px;
}

.country-button {
  width: 100%;
  padding: 8px 12px;
  border: 2px solid #ddd;
  border-radius: 6px;
  background: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-size: 0.9em;
}

.country-button:hover {
  border-color: #dc2626;
}

.country-dropdown {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: white;
  border: 2px solid #ddd;
  border-radius: 6px;
  max-height: 200px;
  overflow-y: auto;
  z-index: 1000;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.country-search {
  width: 100%;
  padding: 8px 12px;
  border: none;
  border-bottom: 1px solid #eee;
  outline: none;
  font-size: 0.9em;
}

.country-option {
  padding: 8px 12px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.9em;
}

.country-option:hover {
  background: #f8f9fa;
}

.country-flag {
  font-size: 1.2em;
}

.phone-prefix {
  padding: 8px 12px;
  border: 2px solid #ddd;
  border-radius: 6px;
  background: #f8f9fa;
  color: #666;
  font-family: monospace;
  min-width: 60px;
  text-align: center;
}

.phone-input {
  border: 2px solid #ddd;
  padding: 8px 12px;
  border-radius: 6px;
  font-family: monospace;
  flex: 1;
  min-width: 150px;
}

.phone-input:focus {
  outline: none;
  border-color: #dc2626;
}

.phone-input.error {
  border-color: #dc3545;
}

.validation-error {
  color: #dc3545;
  font-size: 0.8em;
  margin-top: 4px;
}

.masked-key {
  font-family: monospace;
  letter-spacing: 2px;
}

.user-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  margin-right: 8px;
}

/* Welcome Page Styles */
#welcome-page {
  min-height: 100vh;
  background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
  padding: 60px 20px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.welcome-container {
  max-width: 1200px;
  width: 100%;
}

.welcome-header {
  text-align: center;
  margin-bottom: 60px;
  animation: fadeInDown 0.8s ease;
}

.welcome-header h1 {
  font-size: 3.5em;
  color: white;
  margin-bottom: 20px;
  font-weight: 700;
}

.welcome-header p {
  font-size: 1.3em;
  color: rgba(255, 255, 255, 0.9);
  line-height: 1.6;
}

.welcome-cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 30px;
  margin-bottom: 50px;
}

.welcome-card {
  background: white;
  border-radius: 20px;
  padding: 40px 30px;
  text-align: center;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
  transition: transform 0.3s, box-shadow 0.3s;
  animation: fadeInUp 0.8s ease;
}

.welcome-card:nth-child(2) {
  animation-delay: 0.2s;
}

.welcome-card:nth-child(3) {
  animation-delay: 0.4s;
}

.welcome-card:hover {
  transform: translateY(-10px);
  box-shadow: 0 15px 50px rgba(0, 0, 0, 0.3);
}

.welcome-icon {
  width: 80px;
  height: 80px;
  margin: 0 auto 25px;
  background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
}

.welcome-icon svg {
  width: 40px;
  height: 40px;
}

.welcome-card h3 {
  font-size: 1.5em;
  color: #333;
  margin-bottom: 15px;
}

.welcome-card p {
  color: #666;
  line-height: 1.8;
  font-size: 1.05em;
}

.welcome-footer {
  background: white;
  border-radius: 20px;
  padding: 40px;
  text-align: center;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
  animation: fadeIn 1s ease;
}

.welcome-footer h2 {
  color: #dc2626;
  font-size: 2em;
  margin-bottom: 20px;
}

.welcome-footer p {
  color: #666;
  font-size: 1.1em;
  line-height: 1.8;
  margin-bottom: 30px;
}

.welcome-cta {
  background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
  color: white;
  border: none;
  padding: 18px 50px;
  font-size: 1.2em;
  border-radius: 50px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s;
  box-shadow: 0 5px 20px rgba(220, 38, 38, 0.4);
}

.welcome-cta:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 30px rgba(220, 38, 38, 0.6);
}

@keyframes fadeInDown {
  from {
    opacity: 0;
    transform: translateY(-30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

@media (max-width: 768px) {
  .welcome-header h1 {
    font-size: 2.5em;
  }
  
  .welcome-header p {
    font-size: 1.1em;
  }
  
  .welcome-cards {
    grid-template-columns: 1fr;
  }
}
/* AI Agent Chat Styles */
.ai-prompt-suggestions {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.ai-prompt-btn {
  padding: 10px 16px;
  background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
  color: white;
  border: none;
  border-radius: 20px;
  cursor: pointer;
  font-size: 14px;
  transition: transform 0.2s, box-shadow 0.2s;
}

.ai-prompt-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4);
}

.ai-chat-container {
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  height: 500px;
  display: flex;
  flex-direction: column;
}

.ai-chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.ai-message {
  max-width: 80%;
  padding: 12px 16px;
  border-radius: 12px;
  line-height: 1.5;
  animation: fadeIn 0.3s;
}

.ai-message.user {
  align-self: flex-end;
  background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
  color: white;
}

.ai-message.assistant {
  align-self: flex-start;
  background: #f5f5f5;
  color: #333;
}

.ai-message.loading {
  align-self: flex-start;
  background: #f5f5f5;
  color: #666;
}

.ai-chat-input-container {
  display: flex;
  gap: 10px;
  padding: 16px;
  border-top: 1px solid #eee;
}

.ai-chat-input {
  flex: 1;
  padding: 12px;
  border: 1px solid #ddd;
  border-radius: 8px;
  font-family: inherit;
  font-size: 14px;
  resize: none;
  max-height: 120px;
}

.ai-chat-send {
  padding: 12px 16px;
  background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: transform 0.2s;
}

.ai-chat-send:hover {
  transform: scale(1.05);
}

.ai-chat-send:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

  </style>
</head>
<body>
  <!-- Hamburger Menu -->
<button class="hamburger" onclick="toggleSidebar()">
  <span></span>
  <span></span>
  <span></span>
</button>

<!-- User Greeting -->
<div class="user-greeting" id="userGreeting">Greetings, User</div>

<!-- Sidebar Overlay for mobile -->
<div class="sidebar-overlay" onclick="toggleSidebar()"></div>

<!-- Sidebar -->
<div class="sidebar" id="sidebar">
  <nav class="sidebar-nav">
    <a class="sidebar-item active" data-page="ads">
      <span class="sidebar-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg></span>
      Google Ads Data
    </a>
    <a class="sidebar-item" data-page="tracking">
      <span class="sidebar-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M3 3v18h18v-2H5V3H3zm4 14h2v-6H7v6zm4 0h2V9h-2v8zm4 0h2v-4h-2v4z"/></svg></span>
      Website Tracking
    </a>
    <a class="sidebar-item" data-page="ai-agent">
      <span class="sidebar-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/><path d="M7 9h2v2H7zm4 0h2v2h-2zm4 0h2v2h-2z"/></svg></span>
      Ask our AI Agent
    </a>
    <a class="sidebar-item" data-page="create-campaign">
      <span class="sidebar-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg></span>
      Create Campaign
    </a>
    <a class="sidebar-item" data-page="account">
      <span class="sidebar-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg></span>
      Your Account
    </a>
  </nav>
</div>
<!-- Contact Us Page -->
<div id="contact-page" class="contact-page hidden">
  <button class="back-arrow-btn" onclick="closeContactPage()">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="#667eea"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
  </button>
  <div class="contact-container">
    <div class="contact-header">
      <h1>Get In Touch</h1>
      <p>Have questions? We'd love to hear from you. Send us a message and we'll respond as soon as possible.</p>
    </div>
    
    <div class="contact-content">
      <div class="contact-form-section">
        <h2>Send Us a Message</h2>
        <form id="contactForm" onsubmit="submitContactForm(event)">
          <div class="form-field">
            <label>Your Name *</label>
            <input type="text" required placeholder="John Doe">
          </div>
          
          <div class="form-field">
            <label>Email Address *</label>
            <input type="email" required placeholder="john@example.com">
          </div>
          
          <div class="form-field">
            <label>Subject *</label>
            <input type="text" required placeholder="How can we help?">
          </div>
          
          <div class="form-field">
            <label>Message *</label>
            <textarea required placeholder="Tell us more about your inquiry..."></textarea>
          </div>
          
          <button type="submit" class="submit-btn">Send Message</button>
        </form>
      </div>
      
      <div class="contact-info-section">
        <h2>Contact Information</h2>
        
        <div class="contact-detail">
          <div class="contact-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
          </div>
          <div class="contact-detail-content">
            <h3>Email Support</h3>
            <p><a href="mailto:ashutoshmishra.per@gmail.com">ashutoshmishra.per@gmail.com</a></p>
          </div>
        </div>
        
        <div class="contact-detail">
          <div class="contact-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
          </div>
          <div class="contact-detail-content">
            <h3>Address</h3>
            <p>IIT Kharagpur<br>West Bengal, India</p>
          </div>
        </div>
        
        <div class="contact-detail">
          <div class="contact-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>
          </div>
          <div class="contact-detail-content">
            <h3>Response Time</h3>
            <p>We typically respond within 24 hours during business days.</p>
          </div>
        </div>
        
        <div style="margin-top: 30px;">
          <h3 style="color: #333; margin-bottom: 15px;">Connect With Us</h3>
          <div class="social-links">
            <a href="#" class="social-link" title="LinkedIn">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14m-.5 15.5v-5.3a3.26 3.26 0 0 0-3.26-3.26c-.85 0-1.84.52-2.32 1.3v-1.11h-2.79v8.37h2.79v-4.93c0-.77.62-1.4 1.39-1.4a1.4 1.4 0 0 1 1.4 1.4v4.93h2.79M6.88 8.56a1.68 1.68 0 0 0 1.68-1.68c0-.93-.75-1.69-1.68-1.69a1.69 1.69 0 0 0-1.69 1.69c0 .93.76 1.68 1.69 1.68m1.39 9.94v-8.37H5.5v8.37h2.77z"/></svg>
            </a>
            <a href="#" class="social-link" title="Twitter">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M22.46 6c-.85.38-1.78.64-2.75.76 1-.6 1.76-1.55 2.12-2.68-.93.55-1.96.95-3.06 1.17-.88-.94-2.13-1.53-3.52-1.53-2.67 0-4.83 2.16-4.83 4.83 0 .38.04.75.13 1.1-4.02-.2-7.58-2.13-9.96-5.05-.42.72-.66 1.55-.66 2.44 0 1.68.85 3.16 2.15 4.03-.79-.02-1.54-.24-2.19-.6v.06c0 2.34 1.66 4.29 3.87 4.73-.4.11-.83.17-1.27.17-.31 0-.62-.03-.92-.08.62 1.94 2.42 3.35 4.55 3.39-1.67 1.31-3.77 2.09-6.05 2.09-.39 0-.78-.02-1.17-.07 2.18 1.4 4.77 2.21 7.55 2.21 9.06 0 14.01-7.5 14.01-14.01 0-.21 0-.42-.02-.63.96-.7 1.8-1.56 2.46-2.55z"/></svg>
            </a>
            <a href="#" class="social-link" title="Help Center">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M11 18h2v-2h-2v2zm1-16C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-2.21 0-4 1.79-4 4h2c0-1.1.9-2 2-2s2 .9 2 2c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5 0-2.21-1.79-4-4-4z"/></svg>
            </a>
          </div>
        </div>
      </div>
    </div>
    
    <div style="text-align: center;">
      <button class="back-btn" onclick="closeContactPage()">Back to Dashboard</button>
    </div>
  </div>
</div>

<!-- About Us Page -->
<div id="about-page" class="about-page hidden">
  <button class="back-arrow-btn" onclick="closeAboutPage()">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="#667eea"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
  </button>
  <div class="about-container">
    <div class="about-hero">
      <h1>About Us</h1>
      <p>Empowering businesses with privacy-first analytics and intelligent campaign management</p>
    </div>
    
    <div class="about-section">
      <h2>
        <svg width="30" height="30" viewBox="0 0 24 24" fill="#667eea"><path d="M12 2L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/></svg>
        Our Mission
      </h2>
      <p>We believe that powerful analytics shouldn't come at the cost of privacy. Our mission is to provide businesses with comprehensive campaign insights and website analytics while maintaining the highest standards of data security and user privacy.</p>
      <p>We're building a platform where transparency isn't just a buzzwordâ€”it's the foundation of everything we do.</p>
    </div>
    
    <div class="about-section">
      <h2>
        <svg width="30" height="30" viewBox="0 0 24 24" fill="#667eea"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
        What We Do
      </h2>
      <p>Our platform provides two core services:</p>
      <ul>
        <li><strong>Google Ads Analytics:</strong> Deep insights into your campaign performance with beautiful visualizations, tracking impressions, clicks, conversions, and ROI.</li>
        <li><strong>Website Tracking:</strong> First-party analytics that respects user privacy while giving you the data you need to make informed decisions.</li>
      </ul>
    </div>
    
    <div class="about-section">
      <h2>
        <svg width="30" height="30" viewBox="0 0 24 24" fill="#667eea"><path d="M3 3v18h18v-2H5V3H3zm4 14h2v-6H7v6zm4 0h2V9h-2v8zm4 0h2v-4h-2v4z"/></svg>
        How It Works
      </h2>
      <p>Our end-to-end process is designed for simplicity, security, and transparency:</p>
      
      <div class="process-steps">
        <div class="process-step">
          <h4>1. Sign Up</h4>
          <p>Create your account using Google OAuth. We only request read-only access to your Google Ads dataâ€”nothing more.</p>
        </div>
        
        <div class="process-step">
          <h4>2. Connect Your Accounts</h4>
          <p>Provide your Google Ads developer token and account IDs. We guide you through every step with clear instructions.</p>
        </div>
        
        <div class="process-step">
          <h4>3. Data Sync</h4>
          <p>Our secure API fetches your campaign performance data. We never modify, delete, or access anything beyond what you explicitly authorize.</p>
        </div>
        
        <div class="process-step">
          <h4>4. Insights Dashboard</h4>
          <p>View your analytics in real-time with interactive charts, customizable time ranges, and detailed metrics.</p>
        </div>
      </div>
    </div>
    
    <div class="about-section">
      <h2>
        <svg width="30" height="30" viewBox="0 0 24 24" fill="#667eea"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/></svg>
        Our Technology
      </h2>
      <p>Built on modern, secure infrastructure:</p>
      <ul>
        <li><strong>OAuth 2.0 Authentication:</strong> Industry-standard security for your Google account</li>
        <li><strong>Read-Only API Access:</strong> We can only view your data, never modify it</li>
        <li><strong>Encrypted Data Transfer:</strong> All communications are encrypted end-to-end</li>
        <li><strong>No Data Selling:</strong> Your data is yours. We never sell or share it with third parties</li>
        <li><strong>Privacy-First Tracking:</strong> Our website analytics respect user privacy and comply with GDPR</li>
      </ul>
    </div>
    
    <div class="about-section">
      <h2>
        <svg width="30" height="30" viewBox="0 0 24 24" fill="#667eea"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
        Our Values
      </h2>
      <ul>
        <li><strong>Transparency:</strong> We're open about what we do, how we do it, and why</li>
        <li><strong>Privacy:</strong> Your data security is our top priority</li>
        <li><strong>Simplicity:</strong> Powerful features shouldn't require a PhD to use</li>
        <li><strong>Reliability:</strong> We build systems that work, every time</li>
        <li><strong>Support:</strong> Real humans ready to help when you need us</li>
      </ul>
    </div>
    
    <div class="about-section">
      <h2>
        <svg width="30" height="30" viewBox="0 0 24 24" fill="#667eea"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
        Our Commitment
      </h2>
      <p>We're committed to continuous improvement and long-term growth. As we evolve, we promise to:</p>
      <ul>
        <li>Maintain the highest standards of data security and privacy</li>
        <li>Listen to our users and build features that matter</li>
        <li>Provide responsive, helpful support</li>
        <li>Stay transparent about our practices and policies</li>
        <li>Never compromise on our core values for short-term gains</li>
      </ul>
      <p style="margin-top: 20px;"><strong>Thank you for trusting us with your data. We don't take that responsibility lightly.</strong></p>
    </div>
    
    <div style="text-align: center;">
      <button class="back-btn" onclick="closeAboutPage()">Back to Dashboard</button>
    </div>
  </div>
</div>


  <!-- Floating tech squares background -->
  <div class="tech-squares" id="techSquares"></div>

  <!-- Step 1: Landing Page -->
  <div id="step1-landing" class="hidden">
    <div class="landing-card">
      <h1>Adnalytics</h1>
      <p>Connect with the Google account you use to run your Ads campaigns. Your data stays secure and private.</p>
      
      <input 
        type="text" 
        id="landingUserId" 
        class="user-id-input" 
        placeholder="Enter your company name or identifier"
      />
      
      <button class="google-btn" onclick="startGoogleAuth()">
        <svg width="24" height="24" viewBox="0 0 24 24">
          <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
          <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
          <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
          <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
        </svg>
        Sign in with Google
      </button>
    </div>
  </div>

  <!-- Step 2: Developer Token & Login Customer ID -->
  <div id="step2-config" class="step-container hidden">
    <div class="step-card">
      <h2>Connect Your Ads Account</h2>
      <p class="subtitle">Step 1 complete! Now let's configure your Google Ads access.</p>

      <div id="step2-success" class="success-msg hidden">
        âœ“ Google account connected successfully!
      </div>

      <form id="configForm" onsubmit="submitConfig(event)">
        <div class="form-group">
          <label>User ID / Company Name</label>
          <input type="text" id="step2UserId" required disabled />
          <div class="help-text">
            <strong>What's this?</strong> This is your internal identifier from Step 1. It cannot be changed.
          </div>
        </div>

        <div class="form-group">
          <label>Developer Token</label>
          <input type="text" id="devToken" required placeholder="Enter your Google Ads developer token" />
          <div class="help-text">
            <strong>Where to find it:</strong> Go to Google Ads â†’ Tools & Settings â†’ API Center â†’ Developer Token.
            <br><br>
            <strong>Important:</strong> This token must belong to a Google Ads account that has manager access to the campaigns you want to analyze. If you only have one Ads account (no MCC), you can request a developer token on that same account.
          </div>
        </div>

        <div class="form-group">
          <label>Login Customer ID (Manager/MCC ID)</label>
          <input type="text" id="loginCustomerId" required placeholder="123-456-7890" />
          <div class="help-text">
            <strong>When to use this:</strong> If you have a manager account (MCC) that manages multiple client accounts, enter that manager account's customer ID here.
            <br><br>
            <strong>For single accounts:</strong> If you're using one normal Ads account with a developer token, enter the same customer ID as your Ads account.
            <br><br>
            <strong>Key point:</strong> The developer token's account (or its manager) must have access to the Customer ID you'll query in the next step.
          </div>
        </div>

        <button type="submit" class="primary-btn">Save Configuration</button>
      </form>
    </div>
  </div>

  <!-- Step 3: Enter Customer ID -->
  <div id="step3-customer" class="step-container hidden">
    <div class="step-card">
      <h2>Choose Which Ads Account to Analyze</h2>
      <p class="subtitle">Configuration saved! Now enter the specific Ads account you want to view.</p>

      <div id="step3-success" class="success-msg hidden">
        âœ“ Configuration saved successfully!
      </div>

      <div id="step3-error" class="error-msg hidden"></div>

      <form id="customerForm" onsubmit="fetchPerformance(event)">
        <div class="form-group">
          <label>Customer ID</label>
          <input type="text" id="customerId" required placeholder="123-456-7890" />
          <div class="help-text">
            <strong>What's this?</strong> This is the customer ID of the Ads account that actually runs your campaigns.
            <br><br>
            <strong>Important:</strong> The developer token account (or its manager) must have manager access to this Ads account. You can find this ID in the top right of your Google Ads dashboard.
          </div>
        </div>

        <button type="submit" class="primary-btn" id="fetchBtn">Fetch Campaign Performance</button>
      </form>
    </div>
  </div>

  <!-- Welcome Page -->
  <div id="welcome-page" class="hidden">
    <div class="welcome-container">
      <div class="welcome-header">
        <h1>Welcome, <span id="welcome-username">Friend</span>! ðŸ‘‹</h1>
        <p>We're thrilled to have you here. Let's show you how we roll!</p>
      </div>
      
      <div class="welcome-cards">
        <div class="welcome-card">
          <div class="welcome-icon">
            <svg viewBox="0 0 24 24" fill="white"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/></svg>
          </div>
          <h3>Your Data is Safe</h3>
          <p>We only read your campaign performance data. We never modify, delete, or access anything else in your Google Ads account. Your data stays yours, always.</p>
        </div>
        
        <div class="welcome-card">
          <div class="welcome-icon">
            <svg viewBox="0 0 24 24" fill="white"><path d="M3 3v18h18v-2H5V3H3zm4 14h2v-6H7v6zm4 0h2V9h-2v8zm4 0h2v-4h-2v4z"/></svg>
          </div>
          <h3>Powerful Analytics</h3>
          <p>Get deep insights into your Google Ads campaigns with beautiful visualizations. Track impressions, clicks, conversions, and ROI all in one place.</p>
        </div>
        
        <div class="welcome-card">
          <div class="welcome-icon">
            <svg viewBox="0 0 24 24" fill="white"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
          </div>
          <h3>Privacy First</h3>
          <p>No data selling, no third-party tracking, no hidden agendas. We're built on transparency and respect for your privacy. Your trust is our priority.</p>
        </div>
      </div>
      
      <div class="welcome-footer">
        <h2>Ready to Dive In?</h2>
        <p>Explore your campaign performance, track website analytics, and manage your account settings. Everything you need is just a click away in the sidebar.</p>
        <button class="welcome-cta" onclick="closeWelcomePage()">Let's Get Started!</button>
      </div>
    </div>
  </div>

  <!-- Contact Us Page -->
  <div id="contact-page" class="contact-page hidden">
    <div class="contact-container">
      <div class="contact-header">
        <h1>Get In Touch</h1>
        <p>Have questions? We'd love to hear from you. Send us a message and we'll respond as soon as possible.</p>
      </div>
      
      <div class="contact-content">
        <div class="contact-form-section">
          <h2>Send Us a Message</h2>
          <form id="contactForm" onsubmit="submitContactForm(event)">
            <div class="form-field">
              <label>Your Name *</label>
              <input type="text" required placeholder="John Doe">
            </div>
            
            <div class="form-field">
              <label>Email Address *</label>
              <input type="email" required placeholder="john@example.com">
            </div>
            
            <div class="form-field">
              <label>Subject *</label>
              <input type="text" required placeholder="How can we help?">
            </div>
            
            <div class="form-field">
              <label>Message *</label>
              <textarea required placeholder="Tell us more about your inquiry..."></textarea>
            </div>
            
            <button type="submit" class="submit-btn">Send Message</button>
          </form>
        </div>
        
        <div class="contact-info-section">
          <h2>Contact Information</h2>
          
          <div class="contact-detail">
            <div class="contact-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
            </div>
            <div class="contact-detail-content">
              <h3>Email Support</h3>
              <p><a href="mailto:ashutoshmishra.per@gmail.com">ashutoshmishra.per@gmail.com</a></p>
            </div>
          </div>
          
          <div class="contact-detail">
            <div class="contact-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
            </div>
            <div class="contact-detail-content">
              <h3>Address</h3>
              <p>IIT Kharagpur<br>West Bengal, India</p>
            </div>
          </div>
          
          <div class="contact-detail">
            <div class="contact-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>
            </div>
            <div class="contact-detail-content">
              <h3>Response Time</h3>
              <p>We typically respond within 24 hours during business days.</p>
            </div>
          </div>
          
          <div style="margin-top: 30px;">
            <h3 style="color: #333; margin-bottom: 15px;">Connect With Us</h3>
            <div class="social-links">
              <a href="#" class="social-link" title="LinkedIn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14m-.5 15.5v-5.3a3.26 3.26 0 0 0-3.26-3.26c-.85 0-1.84.52-2.32 1.3v-1.11h-2.79v8.37h2.79v-4.93c0-.77.62-1.4 1.39-1.4a1.4 1.4 0 0 1 1.4 1.4v4.93h2.79M6.88 8.56a1.68 1.68 0 0 0 1.68-1.68c0-.93-.75-1.69-1.68-1.69a1.69 1.69 0 0 0-1.69 1.69c0 .93.76 1.68 1.69 1.68m1.39 9.94v-8.37H5.5v8.37h2.77z"/></svg>
              </a>
              <a href="#" class="social-link" title="Twitter">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M22.46 6c-.85.38-1.78.64-2.75.76 1-.6 1.76-1.55 2.12-2.68-.93.55-1.96.95-3.06 1.17-.88-.94-2.13-1.53-3.52-1.53-2.67 0-4.83 2.16-4.83 4.83 0 .38.04.75.13 1.1-4.02-.2-7.58-2.13-9.96-5.05-.42.72-.66 1.55-.66 2.44 0 1.68.85 3.16 2.15 4.03-.79-.02-1.54-.24-2.19-.6v.06c0 2.34 1.66 4.29 3.87 4.73-.4.11-.83.17-1.27.17-.31 0-.62-.03-.92-.08.62 1.94 2.42 3.35 4.55 3.39-1.67 1.31-3.77 2.09-6.05 2.09-.39 0-.78-.02-1.17-.07 2.18 1.4 4.77 2.21 7.55 2.21 9.06 0 14.01-7.5 14.01-14.01 0-.21 0-.42-.02-.63.96-.7 1.8-1.56 2.46-2.55z"/></svg>
              </a>
              <a href="#" class="social-link" title="Help Center">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M11 18h2v-2h-2v2zm1-16C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-2.21 0-4 1.79-4 4h2c0-1.1.9-2 2-2s2 .9 2 2c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5 0-2.21-1.79-4-4-4z"/></svg>
              </a>
            </div>
          </div>
        </div>
      </div>
      
      <div style="text-align: center;">
        <button class="back-btn" onclick="closeContactPage()">Back to Dashboard</button>
      </div>
    </div>
  </div>

  <!-- About Us Page -->
  <div id="about-page" class="about-page hidden">
    <div class="about-container">
      <div class="about-hero">
        <h1>About Us</h1>
        <p>Empowering businesses with privacy-first analytics and intelligent campaign management</p>
      </div>
      
      <div class="about-section">
        <h2>
          <svg width="30" height="30" viewBox="0 0 24 24" fill="#667eea"><path d="M12 2L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/></svg>
          Our Mission
        </h2>
        <p>We believe that powerful analytics shouldn't come at the cost of privacy. Our mission is to provide businesses with comprehensive campaign insights and website analytics while maintaining the highest standards of data security and user privacy.</p>
        <p>We're building a platform where transparency isn't just a buzzwordâ€”it's the foundation of everything we do.</p>
      </div>
      
      <div class="about-section">
        <h2>
          <svg width="30" height="30" viewBox="0 0 24 24" fill="#667eea"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
          What We Do
        </h2>
        <p>Our platform provides two core services:</p>
        <ul>
          <li><strong>Google Ads Analytics:</strong> Deep insights into your campaign performance with beautiful visualizations, tracking impressions, clicks, conversions, and ROI.</li>
          <li><strong>Website Tracking:</strong> First-party analytics that respects user privacy while giving you the data you need to make informed decisions.</li>
        </ul>
      </div>
      
      <div class="about-section">
        <h2>
          <svg width="30" height="30" viewBox="0 0 24 24" fill="#667eea"><path d="M3 3v18h18v-2H5V3H3zm4 14h2v-6H7v6zm4 0h2V9h-2v8zm4 0h2v-4h-2v4z"/></svg>
          How It Works
        </h2>
        <p>Our end-to-end process is designed for simplicity, security, and transparency:</p>
        
        <div class="process-steps">
          <div class="process-step">
            <h4>1. Sign Up</h4>
            <p>Create your account using Google OAuth. We only request read-only access to your Google Ads dataâ€”nothing more.</p>
          </div>
          
          <div class="process-step">
            <h4>2. Connect Your Accounts</h4>
            <p>Provide your Google Ads developer token and account IDs. We guide you through every step with clear instructions.</p>
          </div>
          
          <div class="process-step">
            <h4>3. Data Sync</h4>
            <p>Our secure API fetches your campaign performance data. We never modify, delete, or access anything beyond what you explicitly authorize.</p>
          </div>
          
          <div class="process-step">
            <h4>4. Insights Dashboard</h4>
            <p>View your analytics in real-time with interactive charts, customizable time ranges, and detailed metrics.</p>
          </div>
        </div>
      </div>
      
      <div class="about-section">
        <h2>
          <svg width="30" height="30" viewBox="0 0 24 24" fill="#667eea"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/></svg>
          Our Technology
        </h2>
        <p>Built on modern, secure infrastructure:</p>
        <ul>
          <li><strong>OAuth 2.0 Authentication:</strong> Industry-standard security for your Google account</li>
          <li><strong>Read-Only API Access:</strong> We can only view your data, never modify it</li>
          <li><strong>Encrypted Data Transfer:</strong> All communications are encrypted end-to-end</li>
          <li><strong>No Data Selling:</strong> Your data is yours. We never sell or share it with third parties</li>
          <li><strong>Privacy-First Tracking:</strong> Our website analytics respect user privacy and comply with GDPR</li>
        </ul>
      </div>
      
      <div class="about-section">
        <h2>
          <svg width="30" height="30" viewBox="0 0 24 24" fill="#667eea"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
          Our Values
        </h2>
        <ul>
          <li><strong>Transparency:</strong> We're open about what we do, how we do it, and why</li>
          <li><strong>Privacy:</strong> Your data security is our top priority</li>
          <li><strong>Simplicity:</strong> Powerful features shouldn't require a PhD to use</li>
          <li><strong>Reliability:</strong> We build systems that work, every time</li>
          <li><strong>Support:</strong> Real humans ready to help when you need us</li>
        </ul>
      </div>
      
      <div class="about-section">
        <h2>
          <svg width="30" height="30" viewBox="0 0 24 24" fill="#667eea"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
          Our Commitment
        </h2>
        <p>We're committed to continuous improvement and long-term growth. As we evolve, we promise to:</p>
        <ul>
          <li>Maintain the highest standards of data security and privacy</li>
          <li>Listen to our users and build features that matter</li>
          <li>Provide responsive, helpful support</li>
          <li>Stay transparent about our practices and policies</li>
          <li>Never compromise on our core values for short-term gains</li>
        </ul>
        <p style="margin-top: 20px;"><strong>Thank you for trusting us with your data. We don't take that responsibility lightly.</strong></p>
      </div>
      
      <div style="text-align: center;">
        <button class="back-btn" onclick="closeAboutPage()">Back to Dashboard</button>
      </div>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="hidden">
    <div style="background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%); padding: 30px 100px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); display: flex; justify-content: space-between; align-items: center; position: relative; overflow: hidden;">
      <div id="dashboardTechSquares" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0;"></div>
      <h1 style="font-size: 2.3em; color: white; letter-spacing: 2px; margin: 0; position: relative; z-index: 1;">CAMPAIGN WORKSPACE</h1>
      <div style="display: flex; gap: 15px; position: relative; z-index: 1;">
        <button onclick="showAboutPage()" style="background: white; border: 2px solid white; color: #dc2626; padding: 10px 24px; border-radius: 25px; cursor: pointer; font-weight: 600; font-size: 0.95em; transition: all 0.3s;">About Us</button>
        <button onclick="showContactPage()" style="background: white; border: 2px solid white; color: #dc2626; padding: 10px 24px; border-radius: 25px; cursor: pointer; font-weight: 600; font-size: 0.95em; transition: all 0.3s;">Contact Us</button>
      </div>
    </div>
    <div class="header-shadow-divider"></div>
    <!-- Tab 1: Google Ads Analytics -->
    <div id="tab-ads" class="tab-content">
      <h2 style="color: #333; margin-bottom: 30px; font-size: 2em; margin-top: 0;">Your Google Ads Performance:</h2>
      <div class="controls-bar">
        <div class="control-group">
          <label>Campaign</label>
          <select id="campaignSelect" onchange="updateMetrics()">
            <option value="">Select a campaign</option>
          </select>
        </div>
        <div class="control-group">
          <label>Time Range</label>
          <select id="timeRangeSelect" onchange="updateMetrics()">
            <option value="last_week">Last 7 Days</option>
            <option value="last_month">Last 30 Days</option>
            <option value="last_year">Last Year (365 Days)</option>
          </select>
        </div>
      </div>

      <div id="campaignInfo" class="info-strip"></div>
      <div id="metricsDisplay" class="metrics-grid"></div>
      <div id="noDataMsg" class="empty-state hidden">
        <h3>No data available</h3>
        <p>No data for this campaign in the selected time range.</p>
      </div>
    </div>

    
<!-- Tab 2: Website Tracking -->
<div id="tab-tracking" class="tab-content hidden">
  <h2 style="color: #333; margin-bottom: 30px; font-size: 2em; margin-top: 0;">Your Website Performance:</h2>
  <!-- Tracker Installation Section -->
  <div style="margin-bottom: 30px;">
    <h3 style="color: #dc2626; margin-bottom: 15px;"> Installation Script</h3>
    <div id="scriptInstalled" class="hidden" style="padding: 12px; background: #d4edda; border-left: 4px solid #28a745; border-radius: 4px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
      <span style="color: #155724; font-weight: 600;">âœ“ You have already completed pasting the script</span>
      <button onclick="showScriptAgain()" style="padding: 8px 16px; background: white; border: 1px solid #28a745; color: #28a745; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">Show Script Again</button>
    </div>
    <div id="scriptNotInstalled">
      <div style="padding: 12px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px; margin-bottom: 15px;">
        <strong>Add this script to your website's &lt;head&gt; section:</strong>
      </div>
      <div class="code-block" id="trackerSnippet">
        <div style="text-align: center; color: #999;">Loading snippet...</div>
      </div>
    </div>
  </div>

  <!-- Key Metrics Overview -->
  <div id="keyMetricsSection" style="margin-bottom: 30px;">
    <h3 style="color: #dc2626; margin-bottom: 15px;"> Key Metrics</h3>
    <div id="keyMetrics" class="info-strip">
      <div style="text-align: center; padding: 40px; color: #999;">
        <p>Loading analytics data...</p>
      </div>
    </div>
  </div>

  <!-- Page Performance Section -->
  <div id="pagePerformanceSection" style="margin-bottom: 30px;" class="hidden">
    <h3 style="color: #dc2626; margin-bottom: 15px;"> Page Performance</h3>
    <div id="pagePerformance"></div>
  </div>

  <!-- Click Analysis Section -->
  <div id="clickAnalysisSection" style="margin-bottom: 30px;" class="hidden">
    <h3 style="color: #dc2626; margin-bottom: 15px;"> Click Analysis</h3>
    <div id="clickAnalysis"></div>
  </div>

  <!-- User Behavior Section -->
  <div id="userBehaviorSection" style="margin-bottom: 30px;" class="hidden">
    <h3 style="color: #dc2626; margin-bottom: 15px;"> User Behavior</h3>
    <div id="userBehavior"></div>
  </div>

  <!-- Empty State -->
  <div id="trackingEmptyState" class="placeholder-section hidden">
    <h3>No Tracking Data Yet</h3>
    <p>Once you've installed the script and visitors start arriving, this tab will show onsite behavior and analytics.</p>
    <p style="margin-top: 15px; font-size: 0.9em; color: #999;">
      Make sure the tracking script is installed on your website and try visiting a few pages to generate test data.
    </p>
  </div>
</div>

<!-- Tab 3: Account -->
<div id="tab-account" class="tab-content hidden">
  <h2 style="color: #333; margin-bottom: 30px; font-size: 2em; margin-top: 0;">Your Account:</h2>
  
  <div class="account-grid">
    <!-- Profile Section -->
    <div class="account-section">
      <h3><svg width="16" height="16" viewBox="0 0 24 24" fill="#667eea"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg> Profile Information</h3>
      
      <div class="account-field">
        <div class="account-field-label">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="#666"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zM9 6c0-1.66 1.34-3 3-3s3 1.34 3 3v2H9V6z"/></svg> Username
        </div>
        <div class="account-field-value readonly" id="account-username">Loading...</div>
      </div>
      
      <div class="account-field">
        <div class="account-field-label">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="#666"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg> Google Account
        </div>
        <div class="account-field-value readonly" id="account-email">
          <img id="account-avatar" class="user-avatar" style="display: none;" alt="Avatar">
          <span>Loading...</span>
        </div>
      </div>
      
      <div class="account-field">
        <div class="account-field-label">
          Phone Number
        </div>
        <div class="account-field-value editable" id="phone-display">
          <span id="phone-value">Not set</span>
          <button class="account-btn" id="phone-edit-btn" onclick="editPhone()" aria-label="Edit phone number">Edit</button>
        </div>
      </div>
      
      <div class="phone-edit-container hidden" id="phone-edit-field">
        <div class="phone-input-row">
          <div class="country-selector">
            <button type="button" class="country-button" id="country-button" onclick="toggleCountryDropdown()">
              <span id="selected-country">ðŸ‡ºðŸ‡¸ +1</span>
              <span>â–¼</span>
            </button>
            <div class="country-dropdown hidden" id="country-dropdown">
              <input type="text" class="country-search" id="country-search" placeholder="Search countries..." oninput="filterCountries()">
              <div id="country-list"></div>
            </div>
          </div>
          <div class="phone-prefix" id="phone-prefix">+1</div>
          <input type="tel" class="phone-input" id="phone-input" placeholder="2345678901" aria-label="Phone number input">
        </div>
        <div style="display: flex; gap: 8px; justify-content: flex-end;">
          <button class="account-btn" onclick="savePhone()" id="phone-save-btn">Save</button>
          <button class="account-btn secondary" onclick="cancelPhoneEdit()">Cancel</button>
        </div>
      </div>
      <div class="validation-error hidden" id="phone-error"></div>
    </div>
    
    <!-- API Configuration -->
    <div class="account-section">
      <h3><svg width="16" height="16" viewBox="0 0 24 24" fill="#667eea"><path d="M12.65 10C11.83 7.67 9.61 6 7 6c-3.31 0-6 2.69-6 6s2.69 6 6 6c2.61 0 4.83-1.67 5.65-4H17v4h4v-4h2v-4H12.65zM7 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/></svg> API Configuration</h3>
      
      <div class="account-field">
        <div class="account-field-label">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="#666"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zM9 6c0-1.66 1.34-3 3-3s3 1.34 3 3v2H9V6z"/></svg> Developer Token
        </div>
        <div class="account-field-value readonly" id="account-dev-token">Loading...</div>
      </div>
      
      <div class="account-field">
        <div class="account-field-label">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="#666"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zM9 6c0-1.66 1.34-3 3-3s3 1.34 3 3v2H9V6z"/></svg> Manager Account ID
        </div>
        <div class="account-field-value readonly" id="account-manager-id">Loading...</div>
      </div>
      
      <div class="account-field">
        <div class="account-field-label">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="#666"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zM9 6c0-1.66 1.34-3 3-3s3 1.34 3 3v2H9V6z"/></svg> Ads Account ID
        </div>
        <div class="account-field-value readonly" id="account-ads-id">Loading...</div>
      </div>
    </div>
    
    <!-- API Keys -->
    <div class="account-section">
      <h3><svg width="16" height="16" viewBox="0 0 24 24" fill="#667eea"><path d="M12.65 10C11.83 7.67 9.61 6 7 6c-3.31 0-6 2.69-6 6s2.69 6 6 6c2.61 0 4.83-1.67 5.65-4H17v4h4v-4h2v-4H12.65zM7 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/></svg> API Keys</h3>
      
      <div class="account-field">
        <div class="account-field-label">Primary API Key</div>
        <div class="account-field-value">
          <span class="masked-key" id="api-key-display">â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</span>
          <button class="account-btn" id="reveal-key-btn" onclick="toggleKeyVisibility()" aria-label="Reveal API key">Reveal</button>
          <button class="account-btn secondary" onclick="regenerateApiKey()" aria-label="Regenerate API key">Regenerate</button>
        </div>
      </div>
    </div>
    
    <!-- Account Actions -->
    <div class="account-section">
      <h3><svg width="16" height="16" viewBox="0 0 24 24" fill="#667eea"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.82,11.69,4.82,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/></svg> Account Actions</h3>
      
      <div class="account-actions">
        <button class="account-btn secondary" onclick="signOut()" aria-label="Sign out of account">Sign Out</button>
        <button class="account-btn danger" onclick="deleteAccount()" aria-label="Delete account">Delete Account</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Account Modal -->
<div id="delete-modal" class="modal-overlay hidden">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">âš ï¸ Delete Account</h2>
      <button class="modal-close" onclick="closeDeleteModal()">Ã—</button>
    </div>
    <div style="padding: 20px 0;">
      <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <strong style="color: #856404;">âš ï¸ Warning: This action is permanent and irreversible!</strong>
      </div>
      <p style="margin-bottom: 15px; line-height: 1.6;">Deleting your account will permanently remove:</p>
      <ul style="margin-bottom: 20px; padding-left: 20px; line-height: 1.8; color: #666;">
        <li>All your profile information and settings</li>
        <li>Google Ads configuration and API tokens</li>
        <li>Campaign performance data and analytics</li>
        <li>Phone number and contact information</li>
        <li>All API keys and access credentials</li>
      </ul>
      <p style="margin-bottom: 25px; font-weight: 600; color: #dc3545; font-size: 1.1em;">This data cannot be recovered once deleted. Are you absolutely sure?</p>
      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button class="account-btn secondary" onclick="closeDeleteModal()">Cancel</button>
        <button class="account-btn danger" onclick="confirmDeleteAccount()">Yes, Delete My Account</button>
      </div>
    </div>
  </div>
</div>

<!-- Tab 4: AI Agent -->
<div id="tab-ai-agent" class="tab-content hidden">
  <h2 style="color: #333; margin-bottom: 20px; font-size: 2em; margin-top: 0;">Ask our AI Agent</h2>
  <p style="color: #666; margin-bottom: 30px;">Get insights about your Ad Intelligence and Website Tracking data</p>
  
  <div class="ai-prompt-suggestions">
    <button class="ai-prompt-btn" onclick="usePrompt('Give me an extensive summary of all my data')">ðŸ“Š Give me an extensive summary</button>
    <button class="ai-prompt-btn" onclick="usePrompt('What could I modify in my website to improve performance?')">ðŸŒ What could I modify in my website?</button>
    <button class="ai-prompt-btn" onclick="usePrompt('How should I change my ads campaign for better results?')">ðŸ“ˆ How should I change my ads campaign?</button>
  </div>
  
  <div class="ai-chat-container">
    <div class="ai-chat-messages" id="aiChatMessages"></div>
    <div class="ai-chat-input-container">
      <textarea class="ai-chat-input" id="aiChatInput" placeholder="Ask me anything about your data..." rows="1"></textarea>
      <button class="ai-chat-send" id="aiChatSend" onclick="sendAIMessage()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
      </button>
    </div>
  </div>
</div>

<div id="tab-create-campaign" class="tab-content hidden">
  <h2 style="color: #333; margin-bottom: 20px; font-size: 2em; margin-top: 0;">Create Campaign with AI</h2>
  <p style="color: #666; margin-bottom: 30px;">Describe your campaign goal and let AI generate a complete campaign spec</p>
  
  <!-- Policy Upload Section -->
  <div id="policyUploadSection" style="background: #f8f9fa; border-radius: 12px; padding: 25px; margin-bottom: 20px; border: 2px dashed #ddd;">
    <h3 style="color: #667eea; margin-bottom: 15px; font-size: 1.3em;">ðŸ“„ Company Policy</h3>
    <div id="noPolicyMessage">
      <p style="color: #666; margin-bottom: 15px;">Upload your company policy document to ensure campaigns follow your brand guidelines.</p>
      <input type="file" id="policyFileInput" accept=".txt,.pdf,.doc,.docx" style="display: none;" onchange="handlePolicyUpload(event)">
      <button onclick="document.getElementById('policyFileInput').click()" style="background: #dc2626; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">Upload Policy Document</button>
    </div>
    <div id="hasPolicyMessage" class="hidden" style="display: flex; align-items: center; justify-content: space-between;">
      <div style="display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 2em;">âœ…</span>
        <div>
          <div style="font-weight: 600; color: #28a745;">Policy Uploaded</div>
          <div style="font-size: 0.9em; color: #666;" id="policyFileName">company_policy.txt</div>
        </div>
      </div>
      <button onclick="document.getElementById('policyFileInput').click()" style="background: white; border: 2px solid #dc2626; color: #dc2626; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">Replace</button>
    </div>
  </div>
  
  <div style="background: white; border-radius: 12px; padding: 30px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); margin-bottom: 30px;">
    <div class="form-group">
      <label>Campaign Goal / Description</label>
      <textarea id="campaignQuery" rows="4" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em; font-family: inherit;" placeholder="Example: I want to promote my new eco-friendly water bottles to health-conscious millennials in California with a $50/day budget"></textarea>
    </div>
    <div class="form-group">
      <label>Landing Page URL (Optional)</label>
      <input type="url" id="landingUrl" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em;" placeholder="https://example.com/product">
    </div>
    <div class="form-group" style="display: flex; align-items: center; gap: 10px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 2px solid #e0e0e0;">
      <input type="checkbox" id="useCompanyPolicy" style="width: 20px; height: 20px; cursor: pointer;">
      <label for="useCompanyPolicy" style="margin: 0; cursor: pointer; font-weight: 600; color: #333;">Use company policy guidelines for this campaign</label>
    </div>
    <button onclick="generateCampaign()" class="primary-btn" id="generateBtn">Generate Campaign</button>
  </div>
  <div id="campaignPreview" class="hidden" style="background: white; border-radius: 12px; padding: 30px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);">
    <h3 style="color: #667eea; margin-bottom: 20px;">Campaign Preview</h3>
    <div id="previewContent"></div>
    <div id="campaignSpecJson" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 20px; max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 0.9em;"></div>
    <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;"><strong>âš ï¸ Review Required:</strong> This campaign will be created in PAUSED status. Review carefully before submitting.</div>
    <button onclick="submitCampaign()" class="primary-btn" id="submitCampaignBtn" style="margin-top: 20px;">Create Campaign in Google Ads</button>
  </div>
</div>

  <script>
    const BACKEND_BASE = 'https://google-ads-backend-32929371500.us-central1.run.app';
    let performanceData = null;
    let currentUserId = null;
    let setupChatMessages = [];
    let setupComplete = false;
    let setupData = null;

    // Agentic Setup Flow
    function initAgenticSetup() {
      const landingCard = document.querySelector('.landing-card');
      landingCard.innerHTML = `
        <h1>Adnalytics</h1>
        <p>Let's get you set up! I'll guide you through connecting your Google Ads account.</p>
        <button class="google-btn" onclick="startAgenticSetup()">
          <svg width="24" height="24" viewBox="0 0 24 24">
            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
          </svg>
          Sign in with Google
        </button>
      `;
    }

    async function startAgenticSetup() {
      const userId = 'user_' + Date.now();
      currentUserId = userId;
      window.location.href = `${BACKEND_BASE}/auth/google?user_id=${encodeURIComponent(userId)}`;
    }

    function showSetupChat() {
      const landingCard = document.querySelector('.landing-card');
      landingCard.style.maxWidth = '900px';
      landingCard.style.width = '90%';
      landingCard.innerHTML = `
        <h1>Setup Assistant ðŸ¤–</h1>
        <div style="background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 20px; height: 500px; overflow-y: auto;" id="setupChatMessages"></div>
        <div style="display: flex; gap: 10px;">
          <input type="text" id="setupChatInput" placeholder="Type your response..." style="flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px;" onkeypress="if(event.key==='Enter') sendSetupMessage()">
          <button onclick="sendSetupMessage()" style="background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">Send</button>
        </div>
      `;
      addSetupMessage('assistant', "Hi! I'm your setup assistant. What should I call you?");
    }

    function addSetupMessage(role, content) {
      const messagesDiv = document.getElementById('setupChatMessages');
      const msgDiv = document.createElement('div');
      msgDiv.style.cssText = `
        padding: 12px;
        margin-bottom: 10px;
        border-radius: 8px;
        ${role === 'user' ? 'background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%); color: white; margin-left: 20%; text-align: right;' : 'background: white; margin-right: 20%;'}
      `;
      msgDiv.innerHTML = content.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
      messagesDiv.appendChild(msgDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    async function sendSetupMessage() {
      const input = document.getElementById('setupChatInput');
      const message = input.value.trim();
      if (!message) return;
      
      addSetupMessage('user', message);
      input.value = '';
      input.disabled = true;
      
      try {
        const response = await fetch(`${BACKEND_BASE}/api/setup-chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user_id: currentUserId, message: message, session_data: {} })
        });
        
        const data = await response.json();
        if (data.error) {
          addSetupMessage('assistant', 'Error: ' + data.error);
          input.disabled = false;
          return;
        }
        
        addSetupMessage('assistant', data.response);
        
        if (data.complete && data.data) {
          setupComplete = true;
          setupData = data.data;
          input.disabled = true;
          setTimeout(() => completeAgenticSetup(), 2000);
        } else {
          input.disabled = false;
          input.focus();
        }
      } catch (error) {
        addSetupMessage('assistant', 'Error: ' + error.message);
        input.disabled = false;
      }
    }

    async function completeAgenticSetup() {
      try {
        const response = await fetch(`${BACKEND_BASE}/api/complete-setup`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user_id: currentUserId, data: setupData })
        });
        
        const result = await response.json();
        if (result.error) {
          addSetupMessage('assistant', 'Error fetching campaigns: ' + result.error);
          return;
        }
        
        performanceData = result.performance_data;
        storedDevToken = setupData.developer_token;
        storedManagerId = setupData.manager_id;
        storedCustomerId = setupData.campaign_id;
        
        // Update currentUserId to use the username from setup
        currentUserId = setupData.username;
        sessionStorage.setItem('currentUserId', setupData.username);
        
        populateCampaignSelector();
        updateMetrics();
        
        document.getElementById('welcome-username').textContent = setupData.username;
        showStep('welcome-page');
      } catch (error) {
        addSetupMessage('assistant', 'Error: ' + error.message);
      }
    }

    // Initialize floating tech squares
    function initTechSquares() {
      const container = document.getElementById('techSquares');
      const squareCount = 30; // Increased from 15 to 30
      
      for (let i = 0; i < squareCount; i++) {
        const square = document.createElement('div');
        square.className = 'tech-square';
        
        // Random size between 20px and 150px
        const size = Math.random() * 130 + 20;
        square.style.width = `${size}px`;
        square.style.height = `${size}px`;
        
        // Random position
        square.style.left = `${Math.random() * 100}%`;
        square.style.top = `${Math.random() * 100}%`;
        
        // Random animation delay and duration
        square.style.animationDelay = `${Math.random() * 5}s`;
        square.style.animationDuration = `${15 + Math.random() * 15}s`;
        
        container.appendChild(square);
      }
    }

    // Initialize app based on URL parameters
    window.addEventListener('DOMContentLoaded', () => {
      initTechSquares();
      
      const urlParams = new URLSearchParams(window.location.search);
      const fromDotlerParam = urlParams.get('from_dotler');
      const userIdParam = urlParams.get('user_id');
      const customerIdParam = urlParams.get('customer_id');
      const fromAgenticParam = urlParams.get('from_agentic');
      const setupComplete = urlParams.get('setup_complete');
      const userEmailParam = urlParams.get('user_email');
      const developerTokenParam = urlParams.get('developer_token');
      const managerIdParam = urlParams.get('manager_id');
      const usernameParam = urlParams.get('username');
      
      console.log('URL params:', { fromDotlerParam, userIdParam, customerIdParam, fromAgenticParam, setupComplete, userEmailParam, developerTokenParam, managerIdParam, usernameParam });
      console.log('Full URL:', window.location.href);
      
      // DEBUG: Show all URL parameters
      if (setupComplete === 'true') {
        console.log('Setup complete detected. All URL parameters:');
        for (const [key, value] of urlParams.entries()) {
          console.log(`  ${key}: ${value}`);
        }
      }
      
      // Check for stored setup data from agentic flow
      const storedSetupData = localStorage.getItem('googleAdsSetupComplete');
      const storedPerformanceData = localStorage.getItem('googleAdsPerformanceData');
      
      console.log('Stored data check:', { 
        hasSetupData: !!storedSetupData, 
        hasPerformanceData: !!storedPerformanceData 
      });
      
      if (storedSetupData) {
        try {
          const setupData = JSON.parse(storedSetupData);
          console.log('Found stored setup data:', setupData);
          
          currentUserId = setupData.user_id || setupData.username;
          storedCustomerId = setupData.customer_id;
          storedDevToken = setupData.developer_token;
          storedManagerId = setupData.manager_id;
          
          if (storedPerformanceData) {
            console.log('Found stored performance data');
            performanceData = JSON.parse(storedPerformanceData);
          }
          
          sessionStorage.setItem('currentUserId', currentUserId);
          sessionStorage.setItem('inDashboard', 'true');
          
          // Show dashboard with data
          showStep('dashboard');
          switchTab('ads');
          
          if (performanceData) {
            console.log('Using stored performance data');
            populateCampaignSelector();
            updateMetrics();
          } else {
            console.log('No stored performance data, trying to fetch...');
            // Try to fetch data using stored credentials
            setTimeout(() => fetchGoogleAdsData(), 1000);
          }
          return;
        } catch (e) {
          console.error('Error parsing stored setup data:', e);
        }
      } else {
        console.log('No stored setup data found');
      }
      
      // FORCE SHOW DASHBOARD IF FROM DOTLER
      if (fromDotlerParam === 'true' || userIdParam) {
        console.log('From Dotler flow detected:', { userIdParam, customerIdParam });
        currentUserId = userIdParam;
        if (customerIdParam) storedCustomerId = customerIdParam;
        sessionStorage.setItem('currentUserId', userIdParam);
        sessionStorage.setItem('inDashboard', 'true');
        
        // Show dashboard immediately
        showStep('dashboard');
        switchTab('ads');
        
        // Auto-fetch Google Ads data if we have customer ID
        if (customerIdParam) {
          setTimeout(() => fetchGoogleAdsData(), 100);
        } else {
          showNoDataMessage('Please complete the Google Ads setup in the main Dotler app to view your campaign data.');
        }
        return;
      }
      
      const params = new URLSearchParams(window.location.search);
      const step = params.get('step');
      const userId = params.get('user_id');
      const email = params.get('email');
      const error = params.get('error');
      const setupCompleteParam = params.get('setup_complete');
      const performanceDataParam = params.get('performance_data');
      const manualSetup = params.get('manual_setup');
      const fromDotler = params.get('from_dotler');
      const customerId = params.get('customer_id');
      const userEmail = params.get('user_email');
      const developerToken = params.get('developer_token');
      const managerId = params.get('manager_id');
      const username = params.get('username');

      // Store customer ID if provided
      if (customerId) {
        storedCustomerId = customerId;
      }
      
      // Store email if provided
      if (userEmail) {
        storedUserEmail = userEmail;
        console.log('Stored user email from URL:', storedUserEmail);
      }
      
      // Store email from userEmailParam if available
      if (userEmailParam) {
        storedUserEmail = userEmailParam;
        console.log('Stored user email from userEmailParam:', storedUserEmail);
      }

      // If coming from Dotler main app with setup complete
      if (setupComplete === 'true' && (userIdParam || usernameParam)) {
        console.log('Setup complete flow detected:', { userIdParam, usernameParam, customerIdParam, userEmailParam, developerTokenParam, managerIdParam });
        
        // Use username if available, otherwise use userId
        currentUserId = usernameParam || userIdParam;
        if (customerIdParam) storedCustomerId = customerIdParam;
        if (developerTokenParam) storedDevToken = developerTokenParam;
        if (managerIdParam) storedManagerId = managerIdParam;
        
        // CRITICAL: Store the email - this is the key for backend lookups
        if (userEmailParam) {
          storedUserEmail = userEmailParam;
          console.log('Stored user email:', storedUserEmail);
        } else {
          console.error('MISSING EMAIL: userEmailParam is null/undefined');
          console.log('Available URL params:', Object.fromEntries(urlParams.entries()));
        }
        
        sessionStorage.setItem('currentUserId', currentUserId);
        sessionStorage.setItem('inDashboard', 'true');
        
        // If we have all setup data, store it in backend
        if (developerTokenParam && managerIdParam && userEmailParam) {
          // Get OAuth tokens from localStorage
          const user = JSON.parse(localStorage.getItem('user') || '{}');
          
          // Call backend to store the complete setup
          fetch(`${BACKEND_BASE}/api/store-setup`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              user_email: userEmailParam, // Use the email from URL
              developer_token: developerTokenParam,
              manager_id: managerIdParam,
              customer_id: customerIdParam,
              username: currentUserId,
              tokens: user.tokens || user // Pass OAuth tokens
            })
          }).then(response => {
            console.log('Setup data stored:', response.ok);
            // Now fetch Google Ads data
            setTimeout(() => fetchGoogleAdsData(), 1000);
          }).catch(error => {
            console.error('Error storing setup:', error);
            setTimeout(() => fetchGoogleAdsData(), 1000);
          });
        } else {
          console.log('Missing setup data in URL:', { developerTokenParam, managerIdParam, userEmailParam });
          // No setup data in URL, try to fetch with what we have
          setTimeout(() => fetchGoogleAdsData(), 1000);
        }
        
        // Show dashboard immediately
        showStep('dashboard');
        switchTab('ads');
        return;
      }
      
      // If coming from Dotler main app (skip sign-in)
      if (fromDotler === 'true' && userId) {
        currentUserId = userId;
        if (customerId) storedCustomerId = customerId;
        
        // Store email from userEmailParam if available
        if (userEmailParam) {
          storedUserEmail = userEmailParam;
          console.log('Stored user email from userEmailParam:', storedUserEmail);
        }
        
        sessionStorage.setItem('currentUserId', userId);
        sessionStorage.setItem('inDashboard', 'true');
        
        // Force show dashboard immediately
        document.getElementById('dashboard').classList.remove('hidden');
        document.getElementById('sidebar').classList.add('visible');
        document.querySelector('.hamburger').style.display = 'block';
        
        switchTab('ads');
        setTimeout(() => {
          if (customerId) {
            fetchGoogleAdsData();
          }
        }, 100);
        return;
      }
      
      // If coming from Dotler main app with manual setup
      if (manualSetup === 'true' && userId) {
        currentUserId = userId;
        sessionStorage.setItem('currentUserId', userId);
        sessionStorage.setItem('inDashboard', 'true');
        showStep('dashboard');
        const sidebar = document.getElementById('sidebar');
        const hamburger = document.querySelector('.hamburger');
        sidebar.classList.add('visible');
        if (hamburger) hamburger.style.display = 'block';
        switchTab('ads');
        return;
      }

      if (error) {
        alert('Authentication error: ' + error);
        initAgenticSetup();
        showStep('step1-landing');
      } else if (step === '2' && userId) {
        currentUserId = userId;
        sessionStorage.setItem('currentUserId', userId);
        if (email) storedUserEmail = decodeURIComponent(email);
        document.getElementById('step1-landing').classList.remove('hidden');
        showSetupChat();
      } else {
        const savedState = sessionStorage.getItem('currentPage');
        const isInDashboard = sessionStorage.getItem('inDashboard') === 'true';
        const savedUserId = sessionStorage.getItem('currentUserId');
        
        if (isInDashboard && savedUserId) {
          currentUserId = savedUserId;
          showStep('dashboard');
          const sidebar = document.getElementById('sidebar');
          const hamburger = document.querySelector('.hamburger');
          sidebar.classList.add('visible');
          if (hamburger) hamburger.style.display = 'block';
          
          if (savedState && savedState !== 'dashboard') {
            switchTab(savedState);
          } else {
            switchTab('ads');
          }
        } else {
          initAgenticSetup();
          showStep('step1-landing');
        }
      }
    });

    function initDashboardSquares() {
      const container = document.getElementById('dashboardTechSquares');
      if (!container) return;
      container.innerHTML = '';
      const squareCount = 15;
      
      for (let i = 0; i < squareCount; i++) {
        const square = document.createElement('div');
        square.className = 'tech-square';
        const size = Math.random() * 80 + 30;
        square.style.width = `${size}px`;
        square.style.height = `${size}px`;
        square.style.left = `${Math.random() * 100}%`;
        square.style.top = `${Math.random() * 100}%`;
        square.style.animationDelay = `${Math.random() * 5}s`;
        square.style.animationDuration = `${15 + Math.random() * 15}s`;
        container.appendChild(square);
      }
    }

    function showStep(stepId) {
      document.querySelectorAll('#step1-landing, #step2-config, #step3-customer, #welcome-page, #dashboard').forEach(el => {
        el.classList.add('hidden');
      });
      const targetElement = document.getElementById(stepId);
      if (targetElement) {
        targetElement.classList.remove('hidden');
      }
      
      const sidebar = document.getElementById('sidebar');
      const hamburger = document.querySelector('.hamburger');
      const userGreeting = document.getElementById('userGreeting');
      
      if (stepId === 'dashboard') {
        if (sidebar) sidebar.classList.add('visible');
        if (hamburger) hamburger.style.display = 'block';
        if (userGreeting) {
          userGreeting.style.display = 'block';
          userGreeting.textContent = `Greetings, ${currentUserId || 'User'}`;
        }
        initDashboardSquares();
      } else {
        if (sidebar) sidebar.classList.remove('visible');
        if (hamburger) hamburger.style.display = 'none';
        if (userGreeting) userGreeting.style.display = 'none';
      }
    }

    function closeWelcomePage() {
      showStep('dashboard');
      // Show sidebar when entering dashboard
      const sidebar = document.getElementById('sidebar');
      const hamburger = document.querySelector('.hamburger');
      sidebar.classList.add('visible');
      if (hamburger) hamburger.style.display = 'block';
      
      // Mark that we're in dashboard and save user ID
      sessionStorage.setItem('inDashboard', 'true');
      sessionStorage.setItem('currentPage', 'ads');
      if (currentUserId) {
        sessionStorage.setItem('currentUserId', currentUserId);
      }
      initDashboardSquares();
    }

    function startGoogleAuth() {
      const userId = document.getElementById('landingUserId').value.trim() || 'user_' + Date.now();
      currentUserId = userId;
      window.location.href = `${BACKEND_BASE}/auth/google?user_id=${encodeURIComponent(userId)}`;
    }

    async function submitConfig(event) {
      event.preventDefault();
      
      const userId = document.getElementById('step2UserId').value.trim();
      const devToken = document.getElementById('devToken').value.trim();
      const loginCustomerId = document.getElementById('loginCustomerId').value.trim();

      // Validate all fields are filled
      if (!userId || !devToken || !loginCustomerId) {
        alert('Error: All fields are required. Please fill in User ID, Developer Token, and Login Customer ID.');
        return;
      }

      currentUserId = userId;
      
      // Store for account page
      storedDevToken = devToken;
      storedManagerId = loginCustomerId;

      try {
        const response = await fetch(`${BACKEND_BASE}/config`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            user_id: userId,
            developer_token: devToken,
            login_customer_id: loginCustomerId
          })
        });

        const data = await response.json();

        if (!response.ok) {
          alert('Error: ' + (data.error || 'Failed to save configuration'));
          return;
        }

        document.getElementById('step3-success').classList.remove('hidden');
        showStep('step3-customer');
      } catch (error) {
        alert('Error saving configuration: ' + error.message);
      }
    }

    async function fetchPerformance(event) {
      event.preventDefault();
      
      const customerId = document.getElementById('customerId').value.trim();
      const fetchBtn = document.getElementById('fetchBtn');
      const errorDiv = document.getElementById('step3-error');

      fetchBtn.disabled = true;
      fetchBtn.textContent = 'Fetching...';
      errorDiv.classList.add('hidden');
      
      // Store for account page
      storedCustomerId = customerId;

      try {
        const response = await fetch(
          `${BACKEND_BASE}/google-ads/performance?user_id=${encodeURIComponent(currentUserId)}&customer_id=${encodeURIComponent(customerId)}`
        );

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Failed to fetch performance data');
        }

        performanceData = data;
        populateCampaignSelector();
        
        // Show welcome page first
        document.getElementById('welcome-username').textContent = currentUserId || 'Friend';
        showStep('welcome-page');
        
        // Prepare dashboard in background
        updateMetrics();
      } catch (error) {
        errorDiv.textContent = 'Error: ' + error.message + '\n\nPlease double-check your developer token, login customer ID, and Ads customer ID.';
        errorDiv.classList.remove('hidden');
      } finally {
        fetchBtn.disabled = false;
        fetchBtn.textContent = 'Fetch Campaign Performance';
      }
    }

async function fetchGoogleAdsData() {
  if (!currentUserId) {
    console.log('Missing user ID');
    showNoDataMessage('Missing user ID. Please complete the agentic setup first in the main Dotler app.');
    return;
  }

  console.log('Fetching Google Ads data for:', { currentUserId, storedCustomerId, storedUserEmail });
  
  // Show loading state
  const metricsDiv = document.getElementById('metricsDisplay');
  if (metricsDiv) {
    metricsDiv.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">Loading Google Ads data...</div>';
  }
  
  try {
    let apiUserId = storedUserEmail;
    
    // If no stored email, try to get it from backend using username
    if (!apiUserId && currentUserId) {
      try {
        const emailResponse = await fetch(`${BACKEND_BASE}/api/get-user-email?username=${encodeURIComponent(currentUserId)}`);
        if (emailResponse.ok) {
          const emailData = await emailResponse.json();
          apiUserId = emailData.email;
          storedUserEmail = apiUserId;
          console.log('Got email from backend:', apiUserId);
        }
      } catch (e) {
        console.log('Could not get email from backend:', e);
      }
    }
    
    // If currentUserId looks like an email, use it directly
    if (!apiUserId && currentUserId && currentUserId.includes('@')) {
      apiUserId = currentUserId;
    }
    
    // Final fallback: try using username
    if (!apiUserId) {
      console.log('No email found, trying with username as fallback:', currentUserId);
      apiUserId = currentUserId;
    }
    
    console.log('Using API user ID:', apiUserId);
    
    const response = await fetch(
      `${BACKEND_BASE}/google-ads/performance?user_id=${encodeURIComponent(apiUserId)}&customer_id=${encodeURIComponent(storedCustomerId || '3967345682')}`
    );

    console.log('API response status:', response.status);

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error || `API Error: ${response.status}`);
    }

    const data = await response.json();
    console.log('Received data:', data);
    
    performanceData = data;
    
    populateCampaignSelector();
    updateMetrics();
    
  } catch (error) {
    console.error('Error fetching Google Ads data:', error);
    
    // Show debug info and suggest checking backend
    const debugUrl = `${BACKEND_BASE}/api/debug-users`;
    showNoDataMessage(`Error loading data: ${error.message}. 
    
    Debug info: 
    - userId: ${currentUserId}
    - email: ${storedUserEmail || 'null'}
    - customerId: ${storedCustomerId}
    
    Check what's stored in backend: <a href="${debugUrl}" target="_blank">${debugUrl}</a>
    
    <div style="margin-top: 15px; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">
      <strong>Troubleshooting:</strong><br>
      1. Make sure you completed the agentic setup in the main Dotler app<br>
      2. The setup should pass your email address to this page<br>
      3. Backend stores data using email as the key, not username<br>
      4. If email is null, the agentic setup didn't pass it correctly<br>
      5. Check browser console for URL parameters being passed
    </div>`);
  }
}

function showNoDataMessage(message) {
  const infoDiv = document.getElementById('campaignInfo');
  const metricsDiv = document.getElementById('metricsDisplay');
  const noDataMsg = document.getElementById('noDataMsg');
  
  if (infoDiv) infoDiv.innerHTML = '';
  if (metricsDiv) {
    metricsDiv.innerHTML = `
      <div style="grid-column: 1 / -1; text-align: center; padding: 40px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);">
        <h3 style="color: #999; margin-bottom: 15px;">No Data Available</h3>
        <p style="color: #666; margin-bottom: 20px;">${message}</p>
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #dc2626;">
          <h4 style="color: #dc2626; margin-bottom: 10px;">How to get your Google Ads data:</h4>
          <ol style="text-align: left; color: #666; line-height: 1.6; margin: 0; padding-left: 20px;">
            <li>Go back to the main Dotler app</li>
            <li>Navigate to the Google Ads tab</li>
            <li>Complete the AI agentic setup process</li>
            <li>The setup will automatically open this dashboard with your data</li>
          </ol>
        </div>
        <p style="color: #999; font-size: 0.9em; margin-top: 15px;">The agentic setup will guide you through connecting your Google Ads account and fetch your campaign performance data.</p>
      </div>
    `;
  }
  if (noDataMsg) {
    noDataMsg.innerHTML = `<h3>No data available</h3><p>${message}</p>`;
    noDataMsg.classList.remove('hidden');
  }
}
    function populateCampaignSelector() {
      const selector = document.getElementById('campaignSelect');
      if (!selector) return;
      
      selector.innerHTML = '<option value="">Select a campaign</option>';

      if (!performanceData || !performanceData.last_week) {
        selector.innerHTML = '<option value="">No campaigns available</option>';
        return;
      }

      const campaigns = performanceData.last_week || [];
      const uniqueCampaigns = [];
      const seenIds = new Set();

      campaigns.forEach(camp => {
        if (!seenIds.has(camp.id)) {
          seenIds.add(camp.id);
          uniqueCampaigns.push(camp);
        }
      });

      if (uniqueCampaigns.length === 0) {
        selector.innerHTML = '<option value="">No campaigns found</option>';
        return;
      }

      uniqueCampaigns.forEach(camp => {
        const option = document.createElement('option');
        option.value = camp.id;
        option.textContent = `${camp.name} (ID: ${camp.id})`;
        selector.appendChild(option);
      });

      if (uniqueCampaigns.length > 0) {
        selector.value = uniqueCampaigns[0].id;
      }
    }

function updateMetrics() {
  const campaignId = parseInt(document.getElementById('campaignSelect').value);
  const timeRange = document.getElementById('timeRangeSelect').value;

  console.log('updateMetrics called:', { campaignId, timeRange, performanceData });

  if (!campaignId) {
    console.log('No campaign selected');
    return;
  }

  if (!performanceData) {
    console.log('No performance data available, trying to fetch...');
    // Try to fetch data if not available
    if (currentUserId && storedCustomerId) {
      fetchGoogleAdsData();
    } else {
      showNoDataMessage('Please complete Google Ads setup first');
    }
    return;
  }

  const dataKey = timeRange;
  const campaigns = performanceData[dataKey] || [];
  const campaign = campaigns.find(c => c.id === campaignId);

  const infoDiv = document.getElementById('campaignInfo');
  const metricsDiv = document.getElementById('metricsDisplay');
  const noDataMsg = document.getElementById('noDataMsg');

  if (!campaign) {
    infoDiv.innerHTML = '';
    metricsDiv.innerHTML = '';
    noDataMsg.classList.remove('hidden');
    return;
  }

  noDataMsg.classList.add('hidden');

  // Store campaign ID globally for metric graphs
  window.currentCampaignId = campaignId;
  window.currentCustomerId = performanceData.customer_id;

  // Campaign info (time-independent)
  infoDiv.innerHTML = `
    <div class="info-card">
      <div class="info-card-label">Campaign Name</div>
      <div class="info-card-value">${campaign.name}</div>
    </div>
    <div class="info-card">
      <div class="info-card-label">Campaign ID</div>
      <div class="info-card-value">${campaign.id}</div>
    </div>
    <div class="info-card">
      <div class="info-card-label">Status</div>
      <div class="info-card-value">${campaign.status}</div>
    </div>
    <div class="info-card">
      <div class="info-card-label">Channel</div>
      <div class="info-card-value">${campaign.channel.replace(/_/g, ' ')}</div>
    </div>
    <div class="info-card">
      <div class="info-card-label">Sub-Channel</div>
      <div class="info-card-value">${campaign.sub_channel.replace(/_/g, ' ')}</div>
    </div>
    <div class="info-card">
      <div class="info-card-label">Bidding Strategy</div>
      <div class="info-card-value">${campaign.bidding_strategy_type.replace(/_/g, ' ')}</div>
    </div>
  `;

  // Metrics (time-dependent) - now clickable
  const costUSD = (campaign.cost_micros / 1000000).toFixed(2);
  const avgCPC = campaign.average_cpc.toFixed(2);
  const ctr = (campaign.ctr * 100).toFixed(2);
  const convRate = (campaign.conversions_from_interactions_rate * 100).toFixed(2);
  const impressionShare = (campaign.search_impression_share * 100).toFixed(1);
  const budgetLost = (campaign.search_budget_lost_impression_share * 100).toFixed(1);
  const rankLost = (campaign.search_rank_lost_impression_share * 100).toFixed(1);

  metricsDiv.innerHTML = `
    <div class="metric-card ads-metric-clickable" style="cursor: pointer;" data-metric="impressions">
      <div class="metric-label">Impressions</div>
      <div class="metric-value">${campaign.impressions.toLocaleString()}</div>
      <div style="font-size: 0.75em; color: #999; margin-top: 8px;"> Click for trend</div>
    </div>
    <div class="metric-card ads-metric-clickable" style="cursor: pointer;" data-metric="clicks">
      <div class="metric-label">Clicks</div>
      <div class="metric-value">${campaign.clicks.toLocaleString()}</div>
      <div style="font-size: 0.75em; color: #999; margin-top: 8px;"> Click for trend</div>
    </div>
    <div class="metric-card ads-metric-clickable" style="cursor: pointer;" data-metric="ctr">
      <div class="metric-label">CTR</div>
      <div class="metric-value">${ctr}<span class="metric-unit">%</span></div>
      <div style="font-size: 0.75em; color: #999; margin-top: 8px;"> Click for trend</div>
    </div>
    <div class="metric-card ads-metric-clickable" style="cursor: pointer;" data-metric="cost">
      <div class="metric-label">Cost</div>
      <div class="metric-value">$${costUSD}</div>
      <div style="font-size: 0.75em; color: #999; margin-top: 8px;"> Click for trend</div>
    </div>
    <div class="metric-card ads-metric-clickable" style="cursor: pointer;" data-metric="average_cpc">
      <div class="metric-label">Average CPC</div>
      <div class="metric-value">$${avgCPC}</div>
      <div style="font-size: 0.75em; color: #999; margin-top: 8px;"> Click for trend</div>
    </div>
    <div class="metric-card ads-metric-clickable" style="cursor: pointer;" data-metric="conversions">
      <div class="metric-label">Conversions</div>
      <div class="metric-value">${campaign.conversions.toFixed(1)}</div>
      <div style="font-size: 0.75em; color: #999; margin-top: 8px;"> Click for trend</div>
    </div>
    <div class="metric-card">
      <div class="metric-label">All Conversions</div>
      <div class="metric-value">${campaign.all_conversions.toFixed(1)}</div>
    </div>
    <div class="metric-card ads-metric-clickable" style="cursor: pointer;" data-metric="conversions_value">
      <div class="metric-label">Conversion Value</div>
      <div class="metric-value">$${campaign.conversions_value.toFixed(2)}</div>
      <div style="font-size: 0.75em; color: #999; margin-top: 8px;"> Click for trend</div>
    </div>
    <div class="metric-card">
      <div class="metric-label">Conversion Rate</div>
      <div class="metric-value">${convRate}<span class="metric-unit">%</span></div>
    </div>
    <div class="metric-card">
      <div class="metric-label">Impression Share</div>
      <div class="metric-value">${impressionShare}<span class="metric-unit">%</span></div>
    </div>
    <div class="metric-card">
      <div class="metric-label">Budget Lost IS</div>
      <div class="metric-value">${budgetLost}<span class="metric-unit">%</span></div>
    </div>
    <div class="metric-card">
      <div class="metric-label">Rank Lost IS</div>
      <div class="metric-value">${rankLost}<span class="metric-unit">%</span></div>
    </div>
  `;

  // Add click handlers for ads metrics
  const adsMetricCards = document.querySelectorAll('.ads-metric-clickable');
  adsMetricCards.forEach(card => {
    const metricName = card.getAttribute('data-metric');
    const metricLabel = card.querySelector('.metric-label').textContent;
    const metricValue = card.querySelector('.metric-value').textContent;
    
    card.addEventListener('click', () => {
      showAdsMetricGraph(campaignId, metricName, metricLabel, metricValue);
    });
  });
}

function switchTab(tabName) {
  document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));

  if (tabName === 'ads') {
    document.getElementById('tab-ads').classList.remove('hidden');
  } else if (tabName === 'tracking') {
    document.getElementById('tab-tracking').classList.remove('hidden');
    
    // Load tracking data when tab is opened
    updateTrackerSnippet();
    loadTrackingData();
  } else if (tabName === 'ai-agent') {
    document.getElementById('tab-ai-agent').classList.remove('hidden');
  } else if (tabName === 'create-campaign') { 
    document.getElementById('tab-create-campaign').classList.remove('hidden'); 
    checkPolicyStatus();
  } else if (tabName === 'account') {
    document.getElementById('tab-account').classList.remove('hidden');
    loadAccountData();
  }
  
  // Save current tab state and ensure dashboard flag is set
  sessionStorage.setItem('currentPage', tabName);
  sessionStorage.setItem('inDashboard', 'true');
  if (currentUserId) {
    sessionStorage.setItem('currentUserId', currentUserId);
  }
}
function updateTrackerSnippet() {
  const snippetDiv = document.getElementById('trackerSnippet');
  const siteId = currentUserId || 'demo-site-1';
  const backendUrl = BACKEND_BASE;
  
  const snippet = `&lt;script src="${backendUrl}/static/tracker.js" data-site-id="${siteId}"&gt;&lt;/script&gt;`;
  
  snippetDiv.innerHTML = snippet;
}

/**
 * Loads tracking analytics data and displays it
 */
async function loadTrackingData() {
  const siteId = currentUserId || 'demo-site-1';
  const backendUrl = BACKEND_BASE; // Use the actual backend URL
  
  try {
    const consentResponse = await fetch(`${backendUrl}/api/analytics/consent-stats?site_id=${encodeURIComponent(siteId)}`);
    const consentData = consentResponse.ok ? await consentResponse.json() : null;
    
    if (consentData) {
      displayConsentStats(consentData);
    }
    // Load comprehensive analytics overview
    const overviewResponse = await fetch(`${backendUrl}/api/analytics/overview?site_id=${encodeURIComponent(siteId)}`);
    
    if (!overviewResponse.ok) {
      throw new Error(`Analytics API error: ${overviewResponse.status}`);
    }
    
    const overviewData = await overviewResponse.json();
    
    // Load user behavior data
    const behaviorResponse = await fetch(`${backendUrl}/api/analytics/user-behavior?site_id=${encodeURIComponent(siteId)}`);
    const behaviorData = behaviorResponse.ok ? await behaviorResponse.json() : null;
    
    // Display all sections
    displayKeyMetrics(overviewData);
    displayPagePerformance(overviewData.page_statistics);
    displayClickAnalysis(overviewData.click_statistics);
    if (behaviorData) {
      displayUserBehavior(behaviorData);
    }
    
    // Hide empty state if we have data
    if (overviewData.total_events > 0) {
      document.getElementById('trackingEmptyState').classList.add('hidden');
      document.getElementById('pagePerformanceSection').classList.remove('hidden');
      document.getElementById('clickAnalysisSection').classList.remove('hidden');
      if (behaviorData) {
        document.getElementById('userBehaviorSection').classList.remove('hidden');
      }
    } else {
      showTrackingEmptyState();
    }
    
  } catch (error) {
    console.error('Error loading tracking data:', error);
    displayTrackingError(error.message);
  }
}
/**
 * Displays key metrics overview
 */
function showScriptAgain() {
  document.getElementById('scriptInstalled').classList.add('hidden');
  document.getElementById('scriptNotInstalled').classList.remove('hidden');
}

function displayKeyMetrics(data) {
  // Check if script is installed (total_users > 0)
  if (data.total_users > 0) {
    document.getElementById('scriptInstalled').classList.remove('hidden');
    document.getElementById('scriptNotInstalled').classList.add('hidden');
  } else {
    document.getElementById('scriptInstalled').classList.add('hidden');
    document.getElementById('scriptNotInstalled').classList.remove('hidden');
  }
  const metricsDiv = document.getElementById('keyMetrics');
  
  console.log('displayKeyMetrics called with data:', data);
  
  if (!data || data.total_events === 0) {
    showTrackingEmptyState();
    return;
  }
  
  metricsDiv.innerHTML = `
    <div class="info-card metric-clickable" style="cursor: pointer; transition: transform 0.3s;">
      <div class="info-card-label">Total Users</div>
      <div class="info-card-value">${data.total_users.toLocaleString()}</div>
      <div style="font-size: 0.75em; color: #999; margin-top: 8px;"> Click to view trend</div>
    </div>
    <div class="info-card metric-clickable" style="cursor: pointer; transition: transform 0.3s;">
      <div class="info-card-label">Total Pageviews</div>
      <div class="info-card-value">${data.total_pageviews.toLocaleString()}</div>
      <div style="font-size: 0.75em; color: #999; margin-top: 8px;"> Click to view trend</div>
    </div>
    <div class="info-card metric-clickable" style="cursor: pointer; transition: transform 0.3s;">
      <div class="info-card-label">Pages per User</div>
      <div class="info-card-value">${data.pages_per_user}</div>
      <div style="font-size: 0.75em; color: #999; margin-top: 8px;"> Click to view trend</div>
    </div>
    <div class="info-card metric-clickable" style="cursor: pointer; transition: transform 0.3s;">
      <div class="info-card-label">Avg. Time on Page</div>
      <div class="info-card-value">${data.avg_time_on_page_formatted}</div>
      <div style="font-size: 0.75em; color: #999; margin-top: 8px;"> Click to view trend</div>
    </div>
    <div class="info-card metric-clickable" style="cursor: pointer; transition: transform 0.3s;">
      <div class="info-card-label">Total Events</div>
      <div class="info-card-value">${data.total_events.toLocaleString()}</div>
      <div style="font-size: 0.75em; color: #999; margin-top: 8px;"> Click to view trend</div>
    </div>
  `;
  
  console.log('HTML injected, now adding event listeners...');
  
  // Add click event listeners using JavaScript instead of inline onclick
  const cards = metricsDiv.querySelectorAll('.metric-clickable');
  
  console.log('Found cards:', cards.length);
  
  if (cards.length >= 5) {
    cards[0].addEventListener('click', function() {
      console.log('Card 0 clicked - Total Users');
      showMetricGraph('users', 'Total Users', data.total_users);
    });
    
    cards[1].addEventListener('click', function() {
      console.log('Card 1 clicked - Total Pageviews');
      showMetricGraph('pageviews', 'Total Pageviews', data.total_pageviews);
    });
    
    cards[2].addEventListener('click', function() {
      console.log('Card 2 clicked - Pages per User');
      showMetricGraph('pages_per_user', 'Pages per User', data.pages_per_user);
    });
    
    cards[3].addEventListener('click', function() {
      console.log('Card 3 clicked - Avg Time');
      showMetricGraph('avg_time', 'Avg. Time on Page', data.avg_time_on_page_formatted);
    });
    
    cards[4].addEventListener('click', function() {
      console.log('Card 4 clicked - Total Events');
      showMetricGraph('events', 'Total Events', data.total_events);
    });
    
    console.log('Event listeners added successfully');
  } else {
    console.error('Not enough cards found!');
  }
  
  // Add hover effect
  cards.forEach(card => {
    card.addEventListener('mouseenter', function() {
      this.style.transform = 'translateY(-4px)';
      this.style.boxShadow = '0 8px 20px rgba(0, 0, 0, 0.1)';
    });
    card.addEventListener('mouseleave', function() {
      this.style.transform = 'translateY(0)';
      this.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.05)';
    });
  });
}

/**
 * Displays page performance statistics
 */
function displayPagePerformance(pageStats) {
  const perfDiv = document.getElementById('pagePerformance');
  
  if (!pageStats || pageStats.length === 0) {
    perfDiv.innerHTML = '<div class="placeholder-section"><p>No page data available yet</p></div>';
    return;
  }
  
  const tableHTML = `
    <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); overflow-x: auto;">
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="border-bottom: 2px solid #eee;">
            <th style="text-align: left; padding: 12px; font-weight: 600; color: #666;">Page URL</th>
            <th style="text-align: right; padding: 12px; font-weight: 600; color: #666;">Total Visits</th>
            <th style="text-align: right; padding: 12px; font-weight: 600; color: #666;">Unique Users</th>
            <th style="text-align: right; padding: 12px; font-weight: 600; color: #666;">User %</th>
            <th style="text-align: right; padding: 12px; font-weight: 600; color: #666;">Avg Visits/User</th>
            <th style="text-align: right; padding: 12px; font-weight: 600; color: #666;">Avg Time</th>
          </tr>
        </thead>
        <tbody>
          ${pageStats.map((page, index) => `
            <tr style="border-bottom: ${index < pageStats.length - 1 ? '1px solid #f5f5f5' : 'none'};">
              <td style="padding: 12px; color: #333; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                ${escapeHtml(getPageName(page.page_url))}
              </td>
              <td style="padding: 12px; text-align: right; color: #333; font-weight: 600;">
                ${page.total_visits.toLocaleString()}
              </td>
              <td style="padding: 12px; text-align: right; color: #dc2626; font-weight: 600;">
                ${page.unique_users.toLocaleString()}
              </td>
              <td style="padding: 12px; text-align: right;">
                <span style="background: ${getPercentageColor(page.user_percentage)}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85em; font-weight: 600;">
                  ${page.user_percentage}%
                </span>
              </td>
              <td style="padding: 12px; text-align: right; color: #333; font-weight: 500;">
                ${page.avg_visits_per_user}
              </td>
              <td style="padding: 12px; text-align: right; color: #666;">
                ${page.avg_time_formatted}
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;
  
  perfDiv.innerHTML = tableHTML;
}

/**
 * Displays click analysis
 */
function displayClickAnalysis(clickStats) {
  const clickDiv = document.getElementById('clickAnalysis');
  
  if (!clickStats || clickStats.length === 0) {
    clickDiv.innerHTML = '<div class="placeholder-section"><p>No click data available yet</p></div>';
    return;
  }
  
  const gridHTML = `
    <div class="metrics-grid">
      ${clickStats.map(page => `
        <div class="metric-card">
          <div style="margin-bottom: 15px;">
            <div style="font-size: 0.85em; color: #666; margin-bottom: 8px; font-weight: 600;">
              ${escapeHtml(getPageName(page.page_url))}
            </div>
            <div style="height: 2px; background: linear-gradient(90deg, #dc2626 0%, #991b1b 100%); border-radius: 1px;"></div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div>
              <div class="metric-label">Total Clicks</div>
              <div class="metric-value" style="font-size: 1.5em;">${page.total_clicks.toLocaleString()}</div>
            </div>
            <div>
              <div class="metric-label">Users Clicked</div>
              <div class="metric-value" style="font-size: 1.5em;">${page.unique_clickers.toLocaleString()}</div>
            </div>
          </div>
          
          <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #f0f0f0;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span style="font-size: 0.85em; color: #666;">Engagement Rate</span>
              <span style="font-size: 1.1em; font-weight: 700; color: #dc2626;">${page.clicker_percentage}%</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
              <span style="font-size: 0.85em; color: #666;">Avg Clicks/User</span>
              <span style="font-size: 1.1em; font-weight: 700; color: #991b1b;">${page.avg_clicks_per_user}</span>
            </div>
          </div>
        </div>
      `).join('')}
    </div>
  `;
  
  clickDiv.innerHTML = gridHTML;
}

/**
 * Displays user behavior data
 */
function displayUserBehavior(data) {
  const behaviorDiv = document.getElementById('userBehavior');
  
  if (!data) {
    behaviorDiv.innerHTML = '<div class="placeholder-section"><p>No behavior data available yet</p></div>';
    return;
  }
  
  const behaviorHTML = `
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
      <div style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);">
        <h4 style="color: #dc2626; margin-bottom: 15px;">Session Overview</h4>
        <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f0f0f0;">
          <span style="color: #666;">Total Sessions</span>
          <span style="font-weight: 700; color: #333;">${data.total_sessions.toLocaleString()}</span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 12px 0;">
          <span style="color: #666;">Avg Pages/Session</span>
          <span style="font-weight: 700; color: #dc2626;">${data.avg_pages_per_session}</span>
        </div>
      </div>
      
      <div style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);">
        <h4 style="color: #dc2626; margin-bottom: 15px;">Top Entry Pages</h4>
        ${data.top_entry_pages && data.top_entry_pages.length > 0 ? 
          data.top_entry_pages.slice(0, 5).map((entry, idx) => `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; ${idx < 4 ? 'border-bottom: 1px solid #f5f5f5;' : ''}">
              <span style="color: #333; font-size: 0.9em; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 200px;">
                ${escapeHtml(getPageName(entry.page))}
              </span>
              <span style="background: #fef2f2; color: #dc2626; padding: 4px 12px; border-radius: 12px; font-size: 0.85em; font-weight: 600;">
                ${entry.count}
              </span>
            </div>
          `).join('')
          : '<p style="color: #999; text-align: center; padding: 20px;">No data</p>'
        }
      </div>
      
      <div style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);">
        <h4 style="color: #dc2626; margin-bottom: 15px;">Top Exit Pages</h4>
        ${data.top_exit_pages && data.top_exit_pages.length > 0 ?
          data.top_exit_pages.slice(0, 5).map((exit, idx) => `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; ${idx < 4 ? 'border-bottom: 1px solid #f5f5f5;' : ''}">
              <span style="color: #333; font-size: 0.9em; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 200px;">
                ${escapeHtml(getPageName(exit.page))}
              </span>
              <span style="background: #ffe8f0; color: #e83e8c; padding: 4px 12px; border-radius: 12px; font-size: 0.85em; font-weight: 600;">
                ${exit.count}
              </span>
            </div>
          `).join('')
          : '<p style="color: #999; text-align: center; padding: 20px;">No data</p>'
        }
      </div>
    </div>
  `;
  
  behaviorDiv.innerHTML = behaviorHTML;
}

/**
 * Helper: Extract readable page name from URL
 */
function getPageName(url) {
  if (!url) return 'Unknown';
  
  try {
    const urlObj = new URL(url);
    const path = urlObj.pathname;
    
    if (path === '/' || path === '') return 'Homepage';
    
    const parts = path.split('/').filter(p => p);
    const lastPart = parts[parts.length - 1] || 'Home';
    
    return lastPart
      .replace(/\.html?$/i, '')
      .replace(/\.php$/i, '')
      .replace(/_/g, ' ')
      .replace(/-/g, ' ')
      .split(' ')
      .map(word => word.charAt(0).toUpperCase() + word.slice(1))
      .join(' ');
  } catch (e) {
    return url.substring(0, 30) + (url.length > 30 ? '...' : '');
  }
}

/**
 * Helper: Get color based on percentage
 */
function getPercentageColor(percentage) {
  if (percentage >= 75) return '#28a745';
  if (percentage >= 50) return '#667eea';
  if (percentage >= 25) return '#ffc107';
  return '#dc3545';
}

function showTrackingEmptyState() {
  document.getElementById('keyMetrics').innerHTML = '';
  document.getElementById('pagePerformanceSection').classList.add('hidden');
  document.getElementById('clickAnalysisSection').classList.add('hidden');
  document.getElementById('userBehaviorSection').classList.add('hidden');
  document.getElementById('trackingEmptyState').classList.remove('hidden');
}

function displayTrackingError(message) {
  const metricsDiv = document.getElementById('keyMetrics');
  
  const errorHTML = `
    <div style="background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 20px; border-radius: 8px; grid-column: 1 / -1;">
      <strong>Ã¢Å¡ Ã¯Â¸Â Error Loading Tracking Data</strong>
      <p style="margin-top: 10px; margin-bottom: 0;">${escapeHtml(message)}</p>
      <p style="margin-top: 10px; margin-bottom: 0; font-size: 0.9em;">
        Make sure your backend tracking API endpoints are running and accessible.
      </p>
    </div>
  `;
  
  metricsDiv.innerHTML = errorHTML;
  document.getElementById('pagePerformanceSection').classList.add('hidden');
  document.getElementById('clickAnalysisSection').classList.add('hidden');
  document.getElementById('userBehaviorSection').classList.add('hidden');
}

/**
 * Formats timestamp for display
 */
function formatEventTime(timestamp) {
  if (!timestamp) return 'N/A';
  
  try {
    const date = new Date(timestamp);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    
    const diffHours = Math.floor(diffMins / 60);
    if (diffHours < 24) return `${diffHours}h ago`;
    
    const diffDays = Math.floor(diffHours / 24);
    if (diffDays < 7) return `${diffDays}d ago`;
    
    return date.toLocaleDateString();
  } catch (e) {
    return String(timestamp).substring(0, 10);
  }
}

/**
 * Escapes HTML to prevent XSS (basic protection for this dev context)
 */
function escapeHtml(text) {
  if (text === null || text === undefined) return '';
  const div = document.createElement('div');
  div.textContent = String(text);
  return div.innerHTML;
}

/**
 * Show metric graph in modal
 */
async function showMetricGraph(metricType, metricTitle, currentValue) {
  const siteId = currentUserId || 'demo-site-1';
  const backendUrl = BACKEND_BASE; // Use the actual backend URL
  
  // Create modal
  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">${metricTitle} - Last 30 Days</h2>
        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">Ã—</button>
      </div>
      <div style="padding: 15px; background: #f0f4ff; border-radius: 8px; margin-bottom: 20px;">
        <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">Current Value</div>
        <div style="font-size: 2em; font-weight: 700; color: #667eea;">${currentValue}</div>
      </div>
      <div class="loading-spinner">
        <div>Loading chart data...</div>
      </div>
      <div class="chart-container" id="chartContainer" style="display: none;"></div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Close on outside click
  modal.addEventListener('click', function(e) {
    if (e.target === modal) {
      modal.remove();
    }
  });
  
  try {
    // Fetch metric data
    const response = await fetch(
      `${backendUrl}/api/analytics/metric-details?site_id=${encodeURIComponent(siteId)}&metric_type=${metricType}&days=30`
    );
    
    if (!response.ok) {
      throw new Error('Failed to fetch metric data');
    }
    
    const data = await response.json();
    
    // Hide loading, show chart
    modal.querySelector('.loading-spinner').style.display = 'none';
    modal.querySelector('.chart-container').style.display = 'block';
    
    // Render chart
    renderChart(data, metricTitle);
    
  } catch (error) {
    console.error('Error loading metric data:', error);
    modal.querySelector('.loading-spinner').innerHTML = `
      <div style="color: #dc3545;">
        <strong>Error loading data</strong>
        <p style="margin-top: 10px; font-size: 0.9em;">${escapeHtml(error.message)}</p>
      </div>
    `;
  }
}

/**
 * Render chart using basic SVG
 */
function renderChart(data, title) {
  const container = document.getElementById('chartContainer');
  const dailyData = data.data || [];
  
  if (dailyData.length === 0) {
    container.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">No data available for this period</div>';
    return;
  }
  
  const width = container.offsetWidth;
  const height = 400;
  const padding = { top: 20, right: 30, bottom: 60, left: 60 };
  
  const chartWidth = width - padding.left - padding.right;
  const chartHeight = height - padding.top - padding.bottom;
  
  // Find min/max values
  const values = dailyData.map(d => d.value);
  const maxValue = Math.max(...values);
  const minValue = Math.min(...values);
  const valueRange = maxValue - minValue || 1;
  
  // Create SVG
  let svg = `<svg width="${width}" height="${height}" style="background: white;">`;
  
  // Draw grid lines
  for (let i = 0; i <= 5; i++) {
    const y = padding.top + (chartHeight / 5) * i;
    svg += `<line x1="${padding.left}" y1="${y}" x2="${width - padding.right}" y2="${y}" stroke="#f0f0f0" stroke-width="1"/>`;
    
    const value = maxValue - (valueRange / 5) * i;
    svg += `<text x="${padding.left - 10}" y="${y + 5}" text-anchor="end" font-size="12" fill="#666">${value.toFixed(1)}</text>`;
  }
  
  // Draw line chart
  let pathData = '';
  let points = [];
  
  dailyData.forEach((d, i) => {
    const x = padding.left + (chartWidth / (dailyData.length - 1)) * i;
    const y = padding.top + chartHeight - ((d.value - minValue) / valueRange) * chartHeight;
    
    points.push({ x, y, date: d.date, value: d.value });
    
    if (i === 0) {
      pathData += `M ${x} ${y}`;
    } else {
      pathData += ` L ${x} ${y}`;
    }
  });
  
  // Draw area under line
  if (points.length > 0) {
    const areaPath = pathData + ` L ${points[points.length - 1].x} ${padding.top + chartHeight} L ${points[0].x} ${padding.top + chartHeight} Z`;
    svg += `<path d="${areaPath}" fill="url(#gradient)" opacity="0.3"/>`;
  }
  
  // Gradient definition
  svg += `
    <defs>
      <linearGradient id="gradient" x1="0%" y1="0%" x2="0%" y2="100%">
        <stop offset="0%" style="stop-color:#dc2626;stop-opacity:1" />
        <stop offset="100%" style="stop-color:#991b1b;stop-opacity:1" />
      </linearGradient>
    </defs>
  `;
  
  // Draw line
  svg += `<path d="${pathData}" fill="none" stroke="url(#gradient)" stroke-width="3"/>`;
  
  // Draw points
  points.forEach(p => {
    svg += `<circle cx="${p.x}" cy="${p.y}" r="4" fill="#dc2626" stroke="white" stroke-width="2">
      <title>${p.date}: ${p.value}</title>
    </circle>`;
  });
  
  // X-axis labels (show every 5th day)
  dailyData.forEach((d, i) => {
    if (i % 5 === 0 || i === dailyData.length - 1) {
      const x = padding.left + (chartWidth / (dailyData.length - 1)) * i;
      const dateLabel = new Date(d.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      svg += `<text x="${x}" y="${height - padding.bottom + 20}" text-anchor="middle" font-size="11" fill="#666">${dateLabel}</text>`;
    }
  });
  
  svg += '</svg>';
  
  container.innerHTML = svg;
}
/**
 * Show Google Ads metric graph in modal
 */
async function showAdsMetricGraph(campaignId, metricName, metricLabel, currentValue) {
  const backendUrl = BACKEND_BASE;
  const customerId = window.currentCustomerId || performanceData?.customer_id;
  
  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">${metricLabel} - Last 30 Days</h2>
        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
      </div>
      <div style="padding: 15px; background: #f0f4ff; border-radius: 8px; margin-bottom: 20px;">
        <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">Current Value</div>
        <div style="font-size: 2em; font-weight: 700; color: #667eea;">${currentValue}</div>
      </div>
      <div class="loading-spinner">
        <div>Loading chart data...</div>
      </div>
      <div class="chart-container" id="chartContainer" style="display: none;"></div>
    </div>
  `;
  
  document.body.appendChild(modal);
  modal.addEventListener('click', function(e) {
    if (e.target === modal) modal.remove();
  });
  
  try {
    const response = await fetch(
      `${backendUrl}/google-ads/metric-trend?user_id=${encodeURIComponent(currentUserId)}&customer_id=${encodeURIComponent(customerId)}&campaign_id=${campaignId}&metric_name=${metricName}`
    );
    
    if (!response.ok) throw new Error('API returned error status');
    
    const data = await response.json();
    
    modal.querySelector('.loading-spinner').style.display = 'none';
    modal.querySelector('.chart-container').style.display = 'block';
    renderChart(data, metricLabel);
    
  } catch (error) {
    console.error('Error loading metric data:', error);
    modal.querySelector('.loading-spinner').innerHTML = `
      <div style="text-align: center; padding: 40px; color: #999;">
        <h3>No data available</h3>
      </div>
    `;
  }
}
/**
 * Display cookie consent statistics
 */
function displayConsentStats(data) {
  // Create or get consent stats section
  let consentSection = document.getElementById('consentStatsSection');
  
  if (!consentSection) {
    // Create section if it doesn't exist
    consentSection = document.createElement('div');
    consentSection.id = 'consentStatsSection';
    consentSection.style.marginBottom = '30px';
    
    // Insert before key metrics section
    const keyMetricsSection = document.getElementById('keyMetricsSection');
    keyMetricsSection.parentNode.insertBefore(consentSection, keyMetricsSection);
  }
  
  const acceptanceColor = data.acceptance_rate >= 70 ? '#28a745' : data.acceptance_rate >= 50 ? '#ffc107' : '#dc3545';
  
  consentSection.innerHTML = `
    <h3 style="color: #dc2626; margin-bottom: 15px;"> Cookie Consent Overview</h3>
    <div class="info-strip">
      <div class="info-card" style="background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%); color: white;">
        <div class="info-card-label" style="color: rgba(255,255,255,0.9);">Acceptance Rate</div>
        <div class="info-card-value" style="color: white; font-size: 2.5em;">${data.acceptance_rate}%</div>
      </div>
      <div class="info-card">
        <div class="info-card-label">Accepted</div>
        <div class="info-card-value" style="color: #28a745;">${data.accepted_count.toLocaleString()}</div>
      </div>
      <div class="info-card">
        <div class="info-card-label">Declined</div>
        <div class="info-card-value" style="color: #dc3545;">${data.declined_count.toLocaleString()}</div>
      </div>
      <div class="info-card">
        <div class="info-card-label">No Decision</div>
        <div class="info-card-value" style="color: #999;">${data.no_decision_count.toLocaleString()}</div>
      </div>
      <div class="info-card">
        <div class="info-card-label">Total Sessions</div>
        <div class="info-card-value">${data.total_sessions.toLocaleString()}</div>
      </div>
    </div>
  `;
}

// Account page functionality
let currentUserData = null;
let isEditingPhone = false;
let apiKeyRevealed = false;
let storedUserEmail = null;
let storedDevToken = null;
let storedManagerId = null;
let storedCustomerId = null;
let selectedCountryCode = '+1';
let selectedCountryFlag = 'ðŸ‡ºðŸ‡¸';

// Country codes data
const countryCodes = [
  { name: 'United States', code: '+1', flag: 'ðŸ‡ºðŸ‡¸' },
  { name: 'United Kingdom', code: '+44', flag: 'ðŸ‡¬ðŸ‡§' },
  { name: 'Canada', code: '+1', flag: 'ðŸ‡¨ðŸ‡¦' },
  { name: 'Australia', code: '+61', flag: 'ðŸ‡¦ðŸ‡º' },
  { name: 'Germany', code: '+49', flag: 'ðŸ‡©ðŸ‡ª' },
  { name: 'France', code: '+33', flag: 'ðŸ‡«ðŸ‡·' },
  { name: 'India', code: '+91', flag: 'ðŸ‡®ðŸ‡³' },
  { name: 'China', code: '+86', flag: 'ðŸ‡¨ðŸ‡³' },
  { name: 'Japan', code: '+81', flag: 'ðŸ‡¯ðŸ‡µ' },
  { name: 'Brazil', code: '+55', flag: 'ðŸ‡§ðŸ‡·' },
  { name: 'Mexico', code: '+52', flag: 'ðŸ‡²ðŸ‡½' },
  { name: 'Russia', code: '+7', flag: 'ðŸ‡·ðŸ‡º' },
  { name: 'South Korea', code: '+82', flag: 'ðŸ‡°ðŸ‡·' },
  { name: 'Italy', code: '+39', flag: 'ðŸ‡®ðŸ‡¹' },
  { name: 'Spain', code: '+34', flag: 'ðŸ‡ªðŸ‡¸' },
  { name: 'Netherlands', code: '+31', flag: 'ðŸ‡³ðŸ‡±' },
  { name: 'Sweden', code: '+46', flag: 'ðŸ‡¸ðŸ‡ª' },
  { name: 'Norway', code: '+47', flag: 'ðŸ‡³ðŸ‡´' },
  { name: 'Denmark', code: '+45', flag: 'ðŸ‡©ðŸ‡°' },
  { name: 'Finland', code: '+358', flag: 'ðŸ‡«ðŸ‡®' }
];

async function loadAccountData() {
  try {
    // Try to get data from backend first
    let userData = null;
    
    if (currentUserId) {
      try {
        const response = await fetch(`${BACKEND_BASE}/google-ads/performance?user_id=${encodeURIComponent(currentUserId)}&customer_id=dummy`);
        if (response.ok) {
          // This will fail but we can check the debug endpoint
          const debugResponse = await fetch(`${BACKEND_BASE}/api/debug-users`);
          if (debugResponse.ok) {
            const debugData = await debugResponse.json();
            const userKey = Object.keys(debugData.user_data).find(key => 
              debugData.user_data[key].username === currentUserId || key === currentUserId
            );
            if (userKey) {
              const backendData = debugData.user_data[userKey];
              userData = {
                username: currentUserId,
                email: backendData.email || 'Not available',
                developer_token: backendData.has_dev_token ? 'Configured' : 'Not configured',
                manager_account_id: 'Configured',
                ads_account_id: storedCustomerId || 'Not configured'
              };
            }
          }
        }
      } catch (error) {
        console.log('Could not load from backend:', error);
      }
    }
    
    // Fallback to form data and stored values
    if (!userData) {
      const userIdFromStep2 = document.getElementById('step2UserId')?.value;
      const devTokenFromStep2 = document.getElementById('devToken')?.value;
      const managerIdFromStep2 = document.getElementById('loginCustomerId')?.value;
      const customerIdFromStep3 = document.getElementById('customerId')?.value;
      
      userData = {
        username: currentUserId || userIdFromStep2 || 'Demo User',
        email: storedUserEmail || 'Not available',
        developer_token: storedDevToken || devTokenFromStep2 || 'Not configured',
        manager_account_id: storedManagerId || managerIdFromStep2 || 'Not configured',
        ads_account_id: storedCustomerId || customerIdFromStep3 || 'Not configured'
      };
    }
    
    currentUserData = {
      id: userData.username,
      username: userData.username,
      email: userData.email,
      phone: null,
      developer_token: userData.developer_token,
      manager_account_id: userData.manager_account_id,
      ads_account_id: userData.ads_account_id,
      api_keys: [{ id: '1', key_masked: generateMaskedApiKey() }]
    };
    
  } catch (error) {
    console.error('Error loading account data:', error);
    // Use minimal fallback data
    currentUserData = {
      id: currentUserId || 'demo-user',
      username: currentUserId || 'Demo User',
      email: storedUserEmail || 'Not available',
      phone: null,
      developer_token: storedDevToken || 'Not configured',
      manager_account_id: storedManagerId || 'Not configured',
      ads_account_id: storedCustomerId || 'Not configured',
      api_keys: [{ id: '1', key_masked: generateMaskedApiKey() }]
    };
  }
  
  displayAccountData(currentUserData);
}

function generateMaskedApiKey() {
  const prefix = 'ak_';
  const suffix = Math.random().toString(36).substring(2, 6);
  return prefix + 'â€¢'.repeat(20) + suffix;
}

function displayAccountData(userData) {
  document.getElementById('account-username').textContent = userData.username || 'N/A';
  
  const emailElement = document.getElementById('account-email');
  const avatarElement = document.getElementById('account-avatar');
  
  if (userData.email) {
    emailElement.querySelector('span').textContent = userData.email;
    // Generate Google avatar URL based on email
    const avatarUrl = `https://www.gravatar.com/avatar/${btoa(userData.email).substring(0, 32)}?d=identicon&s=32`;
    avatarElement.src = avatarUrl;
    avatarElement.style.display = 'inline-block';
  } else {
    emailElement.querySelector('span').textContent = 'N/A';
  }
  
  document.getElementById('phone-value').textContent = userData.phone || 'Not set';
  document.getElementById('account-dev-token').textContent = userData.developer_token ? maskToken(userData.developer_token) : 'Not configured';
  document.getElementById('account-manager-id').textContent = userData.manager_account_id || 'Not configured';
  document.getElementById('account-ads-id').textContent = userData.ads_account_id || 'Not configured';
  
  if (userData.api_keys && userData.api_keys.length > 0) {
    document.getElementById('api-key-display').textContent = userData.api_keys[0].key_masked;
  }
}

function maskToken(token) {
  if (!token || token.length < 8) return 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
  return token.substring(0, 4) + 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢' + token.substring(token.length - 4);
}

function editPhone() {
  if (isEditingPhone) return;
  
  isEditingPhone = true;
  document.getElementById('phone-display').classList.add('hidden');
  document.getElementById('phone-edit-field').classList.remove('hidden');
  
  // Parse existing phone number
  const existingPhone = currentUserData.phone || '';
  if (existingPhone.startsWith('+')) {
    const country = countryCodes.find(c => existingPhone.startsWith(c.code));
    if (country) {
      selectedCountryCode = country.code;
      selectedCountryFlag = country.flag;
      document.getElementById('selected-country').textContent = `${country.flag} ${country.code}`;
      document.getElementById('phone-prefix').textContent = country.code;
      document.getElementById('phone-input').value = existingPhone.substring(country.code.length);
    }
  } else {
    document.getElementById('phone-input').value = existingPhone;
  }
  
  populateCountryList();
  document.getElementById('phone-input').focus();
  
  // Clear any previous errors
  document.getElementById('phone-error').classList.add('hidden');
}

function cancelPhoneEdit() {
  isEditingPhone = false;
  document.getElementById('phone-display').classList.remove('hidden');
  document.getElementById('phone-edit-field').classList.add('hidden');
  document.getElementById('phone-error').classList.add('hidden');
  document.getElementById('phone-input').classList.remove('error');
  document.getElementById('country-dropdown').classList.add('hidden');
}

function populateCountryList() {
  const countryList = document.getElementById('country-list');
  countryList.innerHTML = '';
  
  countryCodes.forEach(country => {
    const option = document.createElement('div');
    option.className = 'country-option';
    option.innerHTML = `
      <span class="country-flag">${country.flag}</span>
      <span>${country.name}</span>
      <span style="margin-left: auto; color: #666;">${country.code}</span>
    `;
    option.onclick = () => selectCountry(country);
    countryList.appendChild(option);
  });
}

function toggleCountryDropdown() {
  const dropdown = document.getElementById('country-dropdown');
  dropdown.classList.toggle('hidden');
  if (!dropdown.classList.contains('hidden')) {
    document.getElementById('country-search').focus();
  }
}

function selectCountry(country) {
  selectedCountryCode = country.code;
  selectedCountryFlag = country.flag;
  document.getElementById('selected-country').textContent = `${country.flag} ${country.code}`;
  document.getElementById('phone-prefix').textContent = country.code;
  document.getElementById('country-dropdown').classList.add('hidden');
  document.getElementById('phone-input').focus();
}

function filterCountries() {
  const search = document.getElementById('country-search').value.toLowerCase();
  const countryList = document.getElementById('country-list');
  countryList.innerHTML = '';
  
  const filtered = countryCodes.filter(country => 
    country.name.toLowerCase().includes(search) || 
    country.code.includes(search)
  );
  
  filtered.forEach(country => {
    const option = document.createElement('div');
    option.className = 'country-option';
    option.innerHTML = `
      <span class="country-flag">${country.flag}</span>
      <span>${country.name}</span>
      <span style="margin-left: auto; color: #666;">${country.code}</span>
    `;
    option.onclick = () => selectCountry(country);
    countryList.appendChild(option);
  });
}

// Close dropdown when clicking outside
document.addEventListener('click', function(e) {
  const dropdown = document.getElementById('country-dropdown');
  const button = document.getElementById('country-button');
  if (dropdown && !dropdown.contains(e.target) && !button.contains(e.target)) {
    dropdown.classList.add('hidden');
  }
});

function validatePhone(phone) {
  if (!phone) return { valid: true, error: '' };
  
  // Remove spaces and validate digits only
  const cleanPhone = phone.replace(/\s/g, '');
  const digitRegex = /^\d{7,15}$/;
  
  if (digitRegex.test(cleanPhone)) {
    return { valid: true, error: '' };
  }
  
  return { valid: false, error: 'Please enter 7-15 digits only (no spaces or special characters)' };
}

async function savePhone() {
  const phoneInput = document.getElementById('phone-input');
  const phone = phoneInput.value.trim();
  
  const validation = validatePhone(phone);
  if (!validation.valid) {
    phoneInput.classList.add('error');
    document.getElementById('phone-error').textContent = validation.error;
    document.getElementById('phone-error').classList.remove('hidden');
    return;
  }
  
  const fullPhone = phone ? selectedCountryCode + phone : null;
  
  try {
    const response = await fetch(`${BACKEND_BASE}/api/users/${currentUserData.id}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ phone: fullPhone })
    });
    
    if (!response.ok) {
      throw new Error('Failed to update phone number');
    }
    
    const updatedUser = await response.json();
    currentUserData.phone = updatedUser.phone || fullPhone;
    
    document.getElementById('phone-value').textContent = currentUserData.phone || 'Not set';
    cancelPhoneEdit();
    showToast('Phone number updated successfully', 'success');
    
  } catch (error) {
    console.error('Error updating phone:', error);
    // Fallback: update locally
    currentUserData.phone = fullPhone;
    document.getElementById('phone-value').textContent = fullPhone || 'Not set';
    cancelPhoneEdit();
    showToast('Phone number updated (demo mode)', 'success');
  }
}

async function toggleKeyVisibility() {
  const keyDisplay = document.getElementById('api-key-display');
  const revealBtn = document.getElementById('reveal-key-btn');
  
  if (apiKeyRevealed) {
    keyDisplay.textContent = currentUserData.api_keys[0].key_masked;
    revealBtn.textContent = 'Reveal';
    apiKeyRevealed = false;
  } else {
    try {
      // Try to fetch full key from server
      const response = await fetch(`${BACKEND_BASE}/api/keys/reveal`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });
      
      if (response.ok) {
        const result = await response.json();
        keyDisplay.textContent = result.key_full;
      } else {
        // Fallback: generate a demo key
        const demoKey = 'ak_' + Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        keyDisplay.textContent = demoKey;
      }
    } catch (error) {
      // Fallback: generate a demo key
      const demoKey = 'ak_' + Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
      keyDisplay.textContent = demoKey;
    }
    
    revealBtn.textContent = 'Hide';
    apiKeyRevealed = true;
  }
}

async function regenerateApiKey() {
  if (!confirm('Are you sure you want to regenerate your API key? This will invalidate the current key.')) {
    return;
  }
  
  try {
    const response = await fetch(`${BACKEND_BASE}/api/keys/regenerate`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    
    if (response.ok) {
      const result = await response.json();
      
      // Update the display with new key
      currentUserData.api_keys[0].key_masked = result.key_masked;
      document.getElementById('api-key-display').textContent = result.key_masked;
      
      showToast('API key regenerated successfully', 'success');
    } else {
      throw new Error('Server error');
    }
  } catch (error) {
    console.error('Error regenerating API key:', error);
    
    // Fallback: generate new masked key locally
    const newMaskedKey = generateMaskedApiKey();
    currentUserData.api_keys[0].key_masked = newMaskedKey;
    document.getElementById('api-key-display').textContent = newMaskedKey;
    
    showToast('API key regenerated (demo mode)', 'success');
  }
  
  apiKeyRevealed = false;
  document.getElementById('reveal-key-btn').textContent = 'Reveal';
}

function signOut() {
  if (confirm('Are you sure you want to sign out? You will need to sign in again to access your account.')) {
    try {
      fetch(`${BACKEND_BASE}/auth/logout`, { method: 'POST' })
        .then(() => {
          showToast('Signed out successfully', 'success');
          setTimeout(() => {
            window.location.href = '/';
          }, 1000);
        })
        .catch(error => {
          console.error('Error signing out:', error);
          showToast('Signed out (session cleared)', 'success');
          setTimeout(() => {
            window.location.href = '/';
          }, 1000);
        });
    } catch (error) {
      showToast('Signed out (session cleared)', 'success');
      setTimeout(() => {
        window.location.href = '/';
      }, 1000);
    }
  }
}

function deleteAccount() {
  document.getElementById('delete-modal').classList.remove('hidden');
}

function closeDeleteModal() {
  document.getElementById('delete-modal').classList.add('hidden');
}

async function confirmDeleteAccount() {
  try {
    const response = await fetch(`${BACKEND_BASE}/api/users/${currentUserData.id}`, {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' }
    });
    
    if (response.ok) {
      showToast('Account deleted successfully', 'success');
      setTimeout(() => {
        window.location.href = '/';
      }, 2000);
    } else {
      throw new Error('Server error');
    }
  } catch (error) {
    console.error('Error deleting account:', error);
    showToast('Account deletion failed. Please try again or contact support.', 'error');
  }
  
  closeDeleteModal();
}

function showToast(message, type = 'success') {
  const toast = document.createElement('div');
  toast.className = `account-toast ${type === 'error' ? 'error' : ''}`;
  toast.textContent = message;
  
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.remove();
  }, 3000);
}

// Keyboard navigation for phone editing
document.addEventListener('keydown', function(e) {
  if (isEditingPhone && e.key === 'Enter') {
    savePhone();
  } else if (isEditingPhone && e.key === 'Escape') {
    cancelPhoneEdit();
  }
});

// Sidebar functionality
function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  const dashboard = document.getElementById('dashboard');
  const overlay = document.querySelector('.sidebar-overlay');
  const userGreeting = document.getElementById('userGreeting');
  
  if (window.innerWidth <= 768) {
    sidebar.classList.toggle('open');
    overlay.classList.toggle('active');
    if (userGreeting) {
      userGreeting.style.display = sidebar.classList.contains('open') ? 'block' : 'none';
    }
  } else {
    sidebar.classList.toggle('collapsed');
    dashboard.classList.toggle('sidebar-collapsed');
    if (userGreeting) {
      userGreeting.style.display = sidebar.classList.contains('collapsed') ? 'none' : 'block';
    }
  }
}

// Sidebar navigation
document.addEventListener('DOMContentLoaded', function() {
  const sidebarItems = document.querySelectorAll('.sidebar-item');
  
  sidebarItems.forEach(item => {
    item.addEventListener('click', function(e) {
      e.preventDefault();
      
      // Remove active from all
      sidebarItems.forEach(i => i.classList.remove('active'));
      
      // Add active to clicked
      this.classList.add('active');
      
      const page = this.getAttribute('data-page');
      
      // Handle navigation
      if (page === 'ads') {
        switchTab('ads');
      } else if (page === 'tracking') {
        switchTab('tracking');
      } else if (page === 'ai-agent') {
        switchTab('ai-agent');
      } else if (page === 'create-campaign') { switchTab('create-campaign'); } else if (page === 'account') {
        switchTab('account');
      } else if (page === 'dashboard') {
        // Show main dashboard view
        switchTab('ads');
      }
      // Add more page handlers as needed
      
      // Close sidebar on mobile
      if (window.innerWidth <= 768) {
        toggleSidebar();
      }
    });
  });
});
function showContactPage() {
  document.querySelectorAll('#step1-landing, #step2-config, #step3-customer, #welcome-page, #dashboard, #about-page').forEach(el => {
    el.classList.add('hidden');
  });
  document.getElementById('contact-page').classList.remove('hidden');
  
  // Hide sidebar
  document.getElementById('sidebar').classList.remove('visible');
  document.querySelector('.hamburger').style.display = 'none';
}

function closeContactPage() {
  document.getElementById('contact-page').classList.add('hidden');
  document.getElementById('dashboard').classList.remove('hidden');
  
  // Show sidebar
  document.getElementById('sidebar').classList.add('visible');
  document.querySelector('.hamburger').style.display = 'block';
}

function showAboutPage() {
  document.querySelectorAll('#step1-landing, #step2-config, #step3-customer, #welcome-page, #dashboard, #contact-page').forEach(el => {
    el.classList.add('hidden');
  });
  document.getElementById('about-page').classList.remove('hidden');
  
  // Hide sidebar
  document.getElementById('sidebar').classList.remove('visible');
  document.querySelector('.hamburger').style.display = 'none';
}

function closeAboutPage() {
  document.getElementById('about-page').classList.add('hidden');
  document.getElementById('dashboard').classList.remove('hidden');
  
  // Show sidebar
  document.getElementById('sidebar').classList.add('visible');
  document.querySelector('.hamburger').style.display = 'block';
}

async function submitContactForm(event) {
  event.preventDefault();
  
  const form = event.target;
  const submitBtn = form.querySelector('.submit-btn');
  const originalText = submitBtn.textContent;
  
  submitBtn.disabled = true;
  submitBtn.textContent = 'Sending...';
  
  const formData = {
    name: form.querySelector('input[type="text"]').value,
    email: form.querySelector('input[type="email"]').value,
    subject: form.querySelectorAll('input[type="text"]')[1].value,
    message: form.querySelector('textarea').value
  };
  
  try {
    const response = await fetch(`${BACKEND_BASE}/api/contact`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(formData)
    });
    
    if (response.ok) {
      alert('Thank you for your message! We\'ll get back to you within 24 hours.');
      form.reset();
    } else {
      alert('Message sent! We\'ll get back to you soon.');
      form.reset();
    }
  } catch (error) {
    console.error('Error submitting form:', error);
    alert('Thank you for your message! We\'ll get back to you within 24 hours.');
    form.reset();
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = originalText;
  }
}

// AI Agent Chat Functions
const GEMINI_API_KEY = "AIzaSyCesfCtXtjzrMOx6Qh2XH4-mJ4c_hqP-9Q";
const GEMINI_MODEL = "gemini-2.5-flash";
const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1/models/${GEMINI_MODEL}:generateContent`;

function usePrompt(prompt) {
  document.getElementById('aiChatInput').value = prompt;
  sendAIMessage();
}

async function sendAIMessage() {
  const input = document.getElementById('aiChatInput');
  const message = input.value.trim();
  if (!message) return;
  
  const messagesContainer = document.getElementById('aiChatMessages');
  const sendBtn = document.getElementById('aiChatSend');
  
  // Add user message
  const userMsg = document.createElement('div');
  userMsg.className = 'ai-message user';
  userMsg.textContent = message;
  messagesContainer.appendChild(userMsg);
  
  input.value = '';
  sendBtn.disabled = true;
  
  // Add loading message
  const loadingMsg = document.createElement('div');
  loadingMsg.className = 'ai-message loading';
  loadingMsg.textContent = 'Thinking...';
  messagesContainer.appendChild(loadingMsg);
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
  
  try {
    // Gather context data
    const contextData = await gatherContextData();
    
    // Build prompt with context
    const fullPrompt = `You are an AI assistant helping analyze advertising and website data. Here is the current data:

${contextData}

User question: ${message}

Provide a helpful, concise answer based on the data above.`;
    
    const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: fullPrompt }] }]
      })
    });
    
    if (!response.ok) {
      throw new Error(`API Error ${response.status}: ${response.statusText}`);
    }
    
    const data = await response.json();
    const aiResponse = data.candidates?.[0]?.content?.parts?.[0]?.text || 'Sorry, I could not generate a response.';
    
    // Remove loading message
    messagesContainer.removeChild(loadingMsg);
    
    // Add AI response
    const aiMsg = document.createElement('div');
    aiMsg.className = 'ai-message assistant';
    aiMsg.innerHTML = formatMarkdown(aiResponse);
    messagesContainer.appendChild(aiMsg);
    
  } catch (error) {
    messagesContainer.removeChild(loadingMsg);
    const errorMsg = document.createElement('div');
    errorMsg.className = 'ai-message assistant';
    const errorText = error.message.includes('429') || error.message.includes('Too Many') 
      ? 'Rate limit exceeded. Please wait a few minutes and try again. (Free tier: 15 requests/min)'
      : `Error: ${error.message}`;
    errorMsg.textContent = errorText;
    messagesContainer.appendChild(errorMsg);
  }
  
  sendBtn.disabled = false;
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function formatMarkdown(text) {
  return text
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.*?)\*/g, '<em>$1</em>')
    .replace(/\n/g, '<br>');
}

async function gatherContextData() {
  let context = '';
  let hasAnyData = false;
  
  try {
    // Get Ads data from performanceData if available
    if (performanceData && performanceData.last_week && performanceData.last_week.length > 0) {
      hasAnyData = true;
      context += 'GOOGLE ADS DATA:\n';
      context += `Customer ID: ${performanceData.customer_id}\n\nLast 7 Days Campaigns:\n`;
      performanceData.last_week.forEach(c => {
        context += `- ${c.name}: ${c.impressions} impressions, ${c.clicks} clicks, CTR: ${(c.ctr * 100).toFixed(2)}%, Cost: $${(c.cost_micros / 1000000).toFixed(2)}, Conversions: ${c.conversions}\n`;
      });
    }
    
    // Try to get tracking data from backend
    const siteId = currentUserId || 'demo-site-1';
    try {
      const trackingResponse = await fetch(`${BACKEND_BASE}/api/analytics/overview?site_id=${encodeURIComponent(siteId)}`);
      if (trackingResponse.ok) {
        const trackingData = await trackingResponse.json();
        if (trackingData.total_users > 0) {
          hasAnyData = true;
          context += '\nWEBSITE TRACKING DATA:\n';
          context += `Total Users: ${trackingData.total_users}\n`;
          context += `Total Pageviews: ${trackingData.total_pageviews}\n`;
          context += `Pages per User: ${trackingData.pages_per_user}\n`;
          if (trackingData.page_statistics && trackingData.page_statistics.length > 0) {
            context += '\nTop Pages:\n';
            trackingData.page_statistics.slice(0, 5).forEach(p => {
              context += `- ${p.page_url}: ${p.total_visits} visits\n`;
            });
          }
        }
      }
    } catch (e) {
      console.log('Could not fetch tracking data:', e);
    }

    
    if (!hasAnyData) {
      context = 'NO DATA AVAILABLE YET.\n\nThe user has not completed setup or has no campaign/tracking data. Politely inform them that you need data to provide insights. Suggest they:\n1. Complete Google Ads setup and fetch campaign data\n2. Install website tracking script and generate some traffic\n3. Come back once they have data to analyze';
    }
  } catch (error) {
    console.error('Error gathering context:', error);
    context = 'ERROR LOADING DATA. The backend API is not responding. Inform the user there is a technical issue and they should try again later.';
  }
  
  return context;
}

// Auto-resize textarea
document.getElementById('aiChatInput')?.addEventListener('input', function() {
  this.style.height = 'auto';
  this.style.height = Math.min(this.scrollHeight, 120) + 'px';
});

// Send on Enter (Shift+Enter for new line)
document.getElementById('aiChatInput')?.addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendAIMessage();
  }
});


// Policy Upload Functions
async function checkPolicyStatus() {
  if (!currentUserId) return;
  try {
    const response = await fetch(`${BACKEND_BASE}/api/policy-status?user_id=${encodeURIComponent(currentUserId)}`);
    const data = await response.json();
    if (data.has_policy) {
      document.getElementById('noPolicyMessage').classList.add('hidden');
      document.getElementById('hasPolicyMessage').classList.remove('hidden');
    } else {
      document.getElementById('noPolicyMessage').classList.remove('hidden');
      document.getElementById('hasPolicyMessage').classList.add('hidden');
    }
  } catch (error) {
    console.error('Error checking policy status:', error);
  }
}

async function handlePolicyUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  if (!currentUserId) {
    alert('Please complete setup first');
    return;
  }
  
  const formData = new FormData();
  formData.append('file', file);
  
  try {
    const response = await fetch(`${BACKEND_BASE}/api/upload-policy?user_id=${encodeURIComponent(currentUserId)}`, {
      method: 'POST',
      body: formData
    });
    
    const data = await response.json();
    
    if (response.ok) {
      document.getElementById('noPolicyMessage').classList.add('hidden');
      document.getElementById('hasPolicyMessage').classList.remove('hidden');
      document.getElementById('policyFileName').textContent = file.name;
      alert('âœ… Policy uploaded successfully! You can now use it when creating campaigns.');
    } else {
      alert('âŒ Error: ' + (data.error || 'Failed to upload policy'));
    }
  } catch (error) {
    alert('âŒ Error uploading policy: ' + error.message);
  }
  
  event.target.value = '';
}

async function generateCampaign() {
  const query = document.getElementById('campaignQuery').value.trim();
  const landingUrl = document.getElementById('landingUrl').value.trim();
  const usePolicy = document.getElementById('useCompanyPolicy').checked;
  const generateBtn = document.getElementById('generateBtn');
  if (!query) { alert('Please describe your campaign goal'); return; }
  if (!currentUserId || !storedCustomerId) { alert('Please complete setup first'); return; }
  generateBtn.disabled = true; generateBtn.textContent = 'Generating...';
  try {
    const response = await fetch(`${BACKEND_BASE}/api/create-campaign`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ user_id: currentUserId, customer_id: storedCustomerId, user_query: query, landing_url: landingUrl || null, use_company_policy: usePolicy }) });
    const data = await response.json();
    if (!response.ok) throw new Error(data.error || 'Failed to generate campaign');
    displayCampaignPreview(data.campaign_spec, data.preview);
  } catch (error) { alert('Error: ' + error.message); }
  finally { generateBtn.disabled = false; generateBtn.textContent = 'Generate Campaign'; }
}

let currentCampaignSpec = null;

function displayCampaignPreview(spec, preview) {
  currentCampaignSpec = spec;
  const previewDiv = document.getElementById('campaignPreview');
  const contentDiv = document.getElementById('previewContent');
  const jsonDiv = document.getElementById('campaignSpecJson');
  contentDiv.innerHTML = `<div class="info-strip" style="margin-bottom: 20px;"><div class="info-card"><div class="info-card-label">Campaign Name</div><div class="info-card-value">${escapeHtml(preview.campaign_name)}</div></div><div class="info-card"><div class="info-card-label">Daily Budget</div><div class="info-card-value">${preview.budget}</div></div><div class="info-card"><div class="info-card-label">Headlines</div><div class="info-card-value">${preview.headlines_count}</div></div><div class="info-card"><div class="info-card-label">Descriptions</div><div class="info-card-value">${preview.descriptions_count}</div></div><div class="info-card"><div class="info-card-label">Keywords</div><div class="info-card-value">${preview.keywords_count}</div></div></div>`;
  jsonDiv.textContent = JSON.stringify(spec, null, 2);
  previewDiv.classList.remove('hidden');
  previewDiv.scrollIntoView({ behavior: 'smooth' });
}

async function submitCampaign() {
  if (!currentCampaignSpec) { alert('No campaign to submit'); return; }
  if (!confirm('Create this campaign in Google Ads? It will be created in PAUSED status for your review.')) return;
  const submitBtn = document.getElementById('submitCampaignBtn');
  submitBtn.disabled = true;
  submitBtn.textContent = 'Creating Campaign...';
  try {
    const response = await fetch(`${BACKEND_BASE}/api/submit-campaign`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        user_id: currentUserId,
        customer_id: storedCustomerId,
        campaign_spec: currentCampaignSpec
      })
    });
    const data = await response.json();
    if (!response.ok) throw new Error(data.error || 'Failed to create campaign');
    alert(`âœ… Campaign created successfully!\n\nCampaign ID: ${data.campaign_id}\nStatus: ${data.status}\n\nYou can now review and enable it in Google Ads.`);
    document.getElementById('campaignQuery').value = '';
    document.getElementById('landingUrl').value = '';
    document.getElementById('campaignPreview').classList.add('hidden');
    currentCampaignSpec = null;
  } catch (error) {
    alert('âŒ Error creating campaign:\n\n' + error.message + '\n\nNote: Test accounts have read-only access. You need Standard Access approval from Google Ads to create campaigns.');
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = 'Create Campaign in Google Ads';
  }
}
  </script>
</body>
</html>
